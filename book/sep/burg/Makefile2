include ${SEPINC}/SEP.top
RESDIR = ./Fig
HTMLDIR = .

RESULTSER = otens int splin mesh gal cross \
	    hole seab passfill \
	    sean2 sean2-dip sean2-int sean2-close \
	    qdome cube \
	    cup cupdata tslice fslice all \
	    shot3 shotin elfshot3 elfshotin \
	    sthree bob aliasp2 off-imp fold-win
RESULTSCR = specc specp phase qslope pmiss arg \
	    bin-win smo2-win int2-win int4-win winslice off4
RESULTSNR = 

UF90LIBS = ${GEELIB}
UF77LIBS = ${BEILIB} ${GEMLIB} -lsepfftf -lsepauxf

DOTS = Dots dots=2 connect=0 gaineach=0 overlap=1. >/dev/null 
GREY = Grey gainpanel=every pclip=100 wantaxis=n >/dev/null crowd=.85 gpow=.7 
PLOT = Grey crowd=.85  wantaxis=0 >/dev/null
SEABGREY = Grey crowd=0.8 pclip=100 >/dev/null \
	transp=n yreverse=n label1=longitude label2=latitude
OGREY = Grey >/dev/null label1=time label2=midpoint pclip=99.5
SGREY = Grey pclip=100 wantaxis=n wheretitle=b titlesz=18 >/dev/null crowd=.88
CUBE = Cubeplot frame1=60 frame2=60 frame3=24 \
       flat=y point1=0.66 point2=0.66 >/dev/null
CUBE = Cubeplot frame1=100  frame2=150 frame3=100 \
       flat=y point1=0.6 point2=0.6 >/dev/null
CUBE2 = Cubeplot frame1=20 frame2=20 frame3=20 wantaxes=0 \
       flat=y point1=0.5 point2=0.5 wantcoordlabel=-1 >/dev/null
CUBE1 = Cubeplot flat=y point1=0.75 point2=0.75  \
        frame1=164 frame2=142 frame3=56 >/dev/null
CUBE3 = ${TRANSP} plane=23 | ${CUBE1}

TRANSP = Transp verb=1 max_memory=100

BOOKDIR = ${SEP}/book

DATDIR = ${BOOKDIR}/gee/Data
MARMDIR = ${DATALIB}/oldq2/marmousi
DATADIR = ../Dat

BINDIR = ../Bin/${MTYPE}
OBJDIR = ../Obj/${MTYPE}
SRCDIR = ../Src

LATOPTS = style=amsmath

Makefile : ;

################## 1-D figures #############################################

in.H: in.HH
	< in.HH Dd esize=4 | Window > $@

otens%.H: Spline1.x
	Spline1.x tension=$* > $@

ltens%.H: otens%.H Plus1.x
	< otens$*.H Plus1.x > $@

${RESDIR}/otens.v: ltens0.01.H ltens0.25.H ltens0.5.H ltens0.75.H ltens1.H
	Cat axis=2 ltens1.H ltens0.75.H ltens0.5.H ltens0.25.H ltens0.01.H | \
	${DOTS} out=$@ \
	labels=tension=1:tension=0.75:tension=0.5:tension=0.25:tension=0.01 

int%.H: in.H otens%.H
	< in.H Miss filt=otens$*.H > $@

in.v: in.H
	< in.H ${DOTS} dots=0 labels=given out=$@

int%.v: int%.H 
	<int$*.H ${DOTS} labels=tension=$* out=$@

${RESDIR}/int.v: ${RESDIR}/int.v3 int0.01.H int0.25.H int0.5.H int0.75.H int1.H
	Merge axis=2 space=n  < \
	int1.H int0.75.H int0.5.H int0.25.H int0.01.H in.H > two.H
	< two.H ${DOTS} out=junk.v corners=12 connect=4 radius=0.02 \
	labels=tension=1:tension=0.75:tension=0.5:tension=0.25:tension=0.01:given 
	< junk.v vppen vpstyle=n xsize=6 ysize=8 > $@

${RESDIR}/int.v3: in.v int0.01.v int0.25.v int0.5.v int0.75.v int1.v
	vp_Movie in.v int0.01.v int0.25.v int0.5.v int0.75.v int1.v > $@

##################### 2-D figures #########################################

# 53 -> 35 (43)
stens%.H: ${BINDIR}/Spline.x
	${BINDIR}/Spline.x tension=$* eps=1.e-3 > $@

# 25 -> 16 (20)
gtens%.H: ${BINDIR}/Spline.x
	${BINDIR}/Spline.x tension=$* eps=5.e-3 > $@

splin%.v : gtens%.H 
	Spike n1=40 n2=40 nsp=2 k1=11,16 k2=8,3 mag=1,-1  > spike.H
	Spike n1=40 n2=40 nsp=2 k1=31,28 k2=24,16 mag=1,-1 > inp2.H
	<spike.H Helicon filt=gtens$*.H > inp1.H
	Add inp1.H inp2.H > inp.H
	<inp.H Helicon       div=1 filt=gtens$*.H > div.H
	<div.H Helicon adj=1 div=1 filt=gtens$*.H > div2.H
	<inp.H  ${GREY} out=inp.v  clip=1 title=tension=$*
	<div.H  ${GREY} out=div.v  clip=1 title=input/filter
	<div2.H ${GREY} out=div2.v pclip=100 title="(input/filter)/filter'"
	vp_SideBySideAniso inp.v div.v div2.v > $@

${RESDIR}/splin.v ${RESDIR}/splin.v3: splin0.v splin0.3.v splin0.7.v splin1.v
	vp_OverUnderAniso splin0.3.v splin0.7.v splin1.v > junk.v
	<junk.v  vppen vpstyle=n txscale=4 > ${RESDIR}/splin.v
	vp_Movie splin0.v splin0.3.v splin0.7.v splin1.v > ${RESDIR}/splin.v3

##################### Galilee ##############################################

gal.H: ${DATDIR}/galilee.H ${BINDIR}/Clip.x
	Cp ${DATDIR}/galilee.H copy.H
	< copy.H Transp > transp.H
	<transp.H ${BINDIR}/Clip.x clip=-212. >gal.H

mesh.H: gal.H ${BINDIR}/Bin1.x galilee.p
	<  gal.H ${BINDIR}/Bin1.x par=galilee.p interp=bin2 > mesh.H

fill%.H:   mesh.H ${BINDIR}/Missgal.x gtens%.H
	< mesh.H ${BINDIR}/Missgal.x eps=0.1 filt=gtens$*.H > fill$*.H niter=20

${RESDIR}/mesh.v: mesh.H
	< mesh.H  ${GREY} allpos=y \
	pclip=94 wantaxis=y yreverse=n transp=n \
	out=junk.v title="Binned" label2="South-North (km)" label1="West-East (km)"
	< junk.v vppen vpstyle=n xsize=3 ysize=4 > $@

gal%.v: fill%.H ${BINDIR}/Igrad.x rect.p
	< fill$*.H ${BINDIR}/Igrad.x   par=rect.p > ruf$*.H
	< ruf$*.H  ${GREY} \
	wantaxis=y pclip=94  yreverse=n transp=n \
	out=gal$*.v title="tension=$*"

cross%.H: fill%.H 
	< fill$*.H Window n2=1 f2=300 n1=440 f1=80 > cross$*.H

${RESDIR}/cross.v: cross0.H cross0.3.H cross0.7.H cross1.H
	Cat axis=2 cross1.H cross0.7.H cross0.3.H cross0.H > cross.H
	< cross.H Scale dscale=-1 | ${DOTS} dots=0 connect=4 out=$@ \
	labels=tension=1:tension=0.7:tension=0.3:tension=0 out=junk.v \
	label1="West-East (km)"
	< junk.v vppen vpstyle=n xsize=6 ysize=6 > $@

${RESDIR}/gal.v3: gal0.v gal0.25.v gal0.5.v gal0.75.v gal1.v
	vp_Movie gal0.v gal0.25.v gal0.5.v gal0.75.v gal1.v > $@

${RESDIR}/gal.v: ${RESDIR}/gal.v3 gal0.v gal0.3.v gal0.7.v gal1.v
	vp_SideBySideAniso gal0.v gal0.3.v > top.v
	vp_SideBySideAniso gal0.7.v gal1.v > bot.v
	vp_OverUnderAniso top.v bot.v > junk.v
	< junk.v vppen vpstyle=n txscale=2 xsize=6 ysize=8 > $@

make2.H: ${BINDIR}/Make.x
	${BINDIR}/Make.x  n1=100 n2=20 > make2.H

hole.H: make2.H ${BINDIR}/Hole.x
	<make2.H ${BINDIR}/Hole.x > hole.H

pqhole.H: hole.H ${BINDIR}/Smooth2.x
	< hole.H Window | ${BINDIR}/Smooth2.x mask=hole.H niter=100 > pqhole.H

pqmiss.H: hole.H ${BINDIR}/Missp.x pqhole.H
	< hole.H ${BINDIR}/Missp.x dip=pqhole.H niter=100 > $@

${RESDIR}/hole.v:  make2.H hole.H pqmiss.H pqhole.H
	<make2.H ${PLOT} title=original out=make.v
	<hole.H ${PLOT} title=gapped   out=hole.v
	< pqhole.H Window n3=1 f3=0 | ${PLOT} title="first dip" out=dip1.v
	< pqhole.H Window n3=1 f3=1 | ${PLOT} title="second dip" out=dip2.v
	<pqmiss.H ${PLOT} title=restored out=miss.v
	vp_SideBySideAniso make.v hole.v dip1.v dip2.v miss.v > junk.v
	<junk.v  vppen vpstyle=n txscale=2. >${RESDIR}/hole.v

bin.H: ${DATDIR}/apr18.H interp2.p ${BINDIR}/Binsea.x 
	Cp ${DATDIR}/apr18.H copy.H
	< copy.H  Transp > wind18.H
	<wind18.H ${BINDIR}/Binsea.x par=interp2.p > bin.H

pbin.H: bin.H ${BINDIR}/Smooth.x  
	< bin.H ${BINDIR}/Smooth.x nw=2 mask=bin.H niter=1000 > $@

seab.H: bin.H pbin.H ${BINDIR}/Miss1.x
	< bin.H ${BINDIR}/Miss1.x nw=2 dip=pbin.H niter=1000 > $@

${RESDIR}/seab.v ${RESDIR}/seab.v3: bin.H seab.H
	< bin.H Window \
	min1=-113.11 max1=-112.5736 min2=-16.1474 max2=-15.6086 | \
	${SEABGREY} out=bin.v title=Binned
	< seab.H Bandpass fhi=90 | Window \
	min1=-113.11 max1=-112.5736 min2=-16.1474 max2=-15.6086 | \
	${SEABGREY} out=int.v title=Interpolated
	vp_SideBySideAniso bin.v int.v > ${RESDIR}/seab.v
	vp_Movie bin.v int.v > ${RESDIR}/seab.v3

pass-dat.H: ${DATDIR}/blast.46.H 
	<${DATDIR}/blast.46.H Window f1=150 n1=150  > $@

pass-mask.H: pass-dat.H ${BINDIR}/Mask3.x
	< pass-dat.H ${BINDIR}/Mask3.x eps=0.00001 > $@

pass-dip.H: pass-dat.H pass-mask.H ${BINDIR}/Smooth3.x 
	< pass-dat.H ${BINDIR}/Smooth3.x nw=2 \
	mask=pass-mask.H nliter=10 > $@

pass-mis.H: pass-dat.H pass-mask.H pass-dip.H ${BINDIR}/Miss3.x 
	< pass-dat.H ${BINDIR}/Miss3.x nw=2 niter=200 \
	mask=pass-mask.H dip=pass-dip.H | Bandpass fhi=50 > $@

WIND = Window n3=1
TOVPLOT = | Grey fastplot=20 crowd=.95 wantaxis=n wanttitle=n > /dev/null
${RESDIR}/passfill.v ${RESDIR}/passfill.v3: pass-dat.H pass-mis.H 
	< pass-dat.H Byte clip=.0007 > data.A
	< data.A ${WIND} f3=00  ${TOVPLOT} out=d00.v
	< data.A ${WIND} f3=01  ${TOVPLOT} out=d01.v
	< data.A ${WIND} f3=02  ${TOVPLOT} out=d02.v
	< data.A ${WIND} f3=03  ${TOVPLOT} out=d03.v
	< data.A ${WIND} f3=04  ${TOVPLOT} out=d04.v
	< data.A ${WIND} f3=05  ${TOVPLOT} out=d05.v
	< data.A ${WIND} f3=06  ${TOVPLOT} out=d06.v
	< data.A ${WIND} f3=07  ${TOVPLOT} out=d07.v
	< data.A ${WIND} f3=08  ${TOVPLOT} out=d08.v
	< data.A ${WIND} f3=09  ${TOVPLOT} out=d09.v
	< data.A ${WIND} f3=10  ${TOVPLOT} out=d10.v
	< data.A ${WIND} f3=11  ${TOVPLOT} out=d11.v
	vp_SideBySideAniso d00.v d01.v d02.v d03.v > r1.v
	vp_SideBySideAniso d04.v d05.v d06.v d07.v > r2.v
	vp_SideBySideAniso d08.v d09.v d10.v d11.v > r3.v
	vp_OverUnderAniso r1.v r2.v r3.v  > data.v
	< pass-mis.H Byte clip=.0007 > miss.A
	< miss.A ${WIND} f3=00  ${TOVPLOT} out=d00.v
	< miss.A ${WIND} f3=01  ${TOVPLOT} out=d01.v
	< miss.A ${WIND} f3=02  ${TOVPLOT} out=d02.v
	< miss.A ${WIND} f3=03  ${TOVPLOT} out=d03.v
	< miss.A ${WIND} f3=04  ${TOVPLOT} out=d04.v
	< miss.A ${WIND} f3=05  ${TOVPLOT} out=d05.v
	< miss.A ${WIND} f3=06  ${TOVPLOT} out=d06.v
	< miss.A ${WIND} f3=07  ${TOVPLOT} out=d07.v
	< miss.A ${WIND} f3=08  ${TOVPLOT} out=d08.v
	< miss.A ${WIND} f3=09  ${TOVPLOT} out=d09.v
	< miss.A ${WIND} f3=10  ${TOVPLOT} out=d10.v
	< miss.A ${WIND} f3=11  ${TOVPLOT} out=d11.v
	vp_SideBySideAniso d00.v d01.v d02.v d03.v > r1.v
	vp_SideBySideAniso d04.v d05.v d06.v d07.v > r2.v
	vp_SideBySideAniso d08.v d09.v d10.v d11.v > r3.v
	vp_OverUnderAniso r1.v r2.v r3.v  > miss.v
	vp_SideBySideAniso data.v miss.v > ${RESDIR}/passfill.v
	vp_Movie           data.v miss.v > ${RESDIR}/passfill.v3


sean.H: ${DATALIB}/2d_real/bp/sean.HH ${BINDIR}/Resampletime.x 
	< ${DATALIB}/2d_real/bp/sean.HH Window n3=1 f3=3 n1=500 | \
	Bandpass fhi=50 | Window j1=2 | \
	${BINDIR}/Resampletime.x d1out=.004 | Pad n1=500 > $@
	echo hff=-1 >> $@

sean2.H: sean.H
	< sean.H Window j2=2 > $@

%-pad.H %-mask2.H: %.H ${BINDIR}/LPad.x
	<$*.H ${BINDIR}/LPad.x jump=2 mask=$*-mask2.H > $*-pad.H

${RESDIR}/sean2.v: sean.H sean2.H
	< sean.H Grey out=dat.v \
	title=Original label2=Channel label1="Time (s)" >/dev/null 
	< sean2.H Grey out=mis.v \
	title=Decimated label2=Channel label1="Time (s)" >/dev/null 
	vp_SideBySideAniso dat.v mis.v > $@

sean2-pq.H: ${BINDIR}/Smooth2.x sean2.H 
	< sean2.H  ${BINDIR}/Smooth2.x nw=3 nj=2 \
	dg=0.5 eps=0.08 niter=100 > $@

sean2-p.H: ${BINDIR}/Smoothq.x sean2-pq.H sean2.H
	< sean2.H ${BINDIR}/Smoothq.x q=sean2-pq.H nw=3 nj=2 niter=100 > $@

sean2-pq1.H: ${BINDIR}/Smooth2.x sean2.H sean2-pq.H sean2-p.H
	< sean2.H ${BINDIR}/Smooth2.x nw=3 nj=2 \
	pfile=sean2-p.H qfile=sean2-pq.H \
	eps=0.08 niter=100 | Transp > $@

%-pq2.H: %-pq1.H ${BINDIR}/Double.x
	< $*-pq1.H ${BINDIR}/Double.x nw=4 | Transp > $@

%-mis.H: %-pad.H %-mask2.H %-pq2.H ${BINDIR}/Missp.x 
	< $*-pad.H ${BINDIR}/Missp.x nw=3 \
	dip=$*-pq2.H mask=$*-mask2.H niter=100 > $@

sean2-mis2.H: sean2-mis.H
	< sean2-mis.H Bandpass fhi=70 > $@


${RESDIR}/sean2-dip.v: sean2-pq2.H
	< sean2-pq2.H Window n3=1 f3=1 | Scale dscale=250 | \
	Grey out=dip1.v title="First Dip" pclip=100 wantscalebar=y \
	label2=Channel label1="Time (s)" >/dev/null 
	< sean2-pq2.H Window n3=1 f3=0 | Scale dscale=250 | \
	Grey out=dip2.v title="Second Dip" pclip=100 wantscalebar=y \
	label2=Channel label1="Time (s)" >/dev/null
	vp_SideBySideAniso dip1.v dip2.v > $@

sean2-dip.v: sean2-pq2.H
	< sean2-pq2.H Window n3=1 f3=1 | Scale dscale=250 | \
	Grey color=j out=dip1.v title="First Dip" pclip=100 wantscalebar=y \
	label2=Channel label1="Time (s)" >/dev/null 
	< sean2-pq2.H Window n3=1 f3=0 | Scale dscale=250 | \
	Grey color=j out=dip2.v title="Second Dip" pclip=100 wantscalebar=y \
	label2=Channel label1="Time (s)" >/dev/null
	vp_SideBySideAniso dip1.v dip2.v > $@

${RESDIR}/sean2-int.v: sean2-mis2.H sean.H
	Add scale=1,-1 sean2-mis2.H sean.H > sean-dif.H
	Cat sean2-mis2.H sean-dif.H | Byte > sean2-int.A
	< sean2-int.A Window n3=1 f3=0 | Ta2vplot out=int.v \
	title="Interpolation Result" \
	label2=Channel label1="Time (s)" >/dev/null 
	< sean2-int.A Window n3=1 f3=1 j2=2 f2=1 | Ta2vplot out=dif.v \
	title="Interpolation Error" \
	label2=Channel label1="Time (s)" >/dev/null 
	vp_SideBySideAniso int.v dif.v > $@

${RESDIR}/sean2-close.v ${RESDIR}/sean2-close.v3: sean.H sean2-mis2.H
	< sean.H Window min1=2.5 max1=3.1 max2=120 | \
	Grey title=Original label2=Channel label1="Time (s)" >/dev/null \
	out=orig.v
	< sean2-mis2.H Window min1=2.5 max1=3.1 max2=120 | \
	Grey title=Interpolated label2=Channel label1="Time (s)" >/dev/null \
	out=intp.v
	vp_SideBySideAniso orig.v intp.v > ${RESDIR}/sean2-close.v
	vp_Movie orig.v intp.v > ${RESDIR}/sean2-close.v3

#qdome.H: ${BINDIR}/Qdome.x qdome.p3 
#	${BINDIR}/Qdome.x par=qdome.p3 > qdome.H 

qdome.H: ${BINDIR}/Qdome-bob.x qd.p
	${BINDIR}/Qdome-bob.x >  f.H par=qd.p
	< f.H Smooth rect1=3 diff1=1  | Smooth rect1=4 | \
	Interp type=1 d2out=.005 d3out=.005   >$@ maxsize=100


%.A: %.H
	< $*.H Byte gainpanel=all > $@

%-hol3.H %-msk3.H: %.H ${BINDIR}/Holes2.x %.p
	< $*.H ${BINDIR}/Holes2.x par=$*.p mask=$*-msk3.H >$*-hol3.H

%-dip3.H: %.H ${BINDIR}/Smooth3.x 
	< $*.H ${BINDIR}/Smooth3.x nw=3 > $@

qdome-dip.H: qdome-hol3.H qdome-msk3.H ${BINDIR}/Smooth3.x 
	< qdome-hol3.H ${BINDIR}/Smooth3.x nw=3 \
	mask=qdome-msk3.H nliter=10 niter=100 > $@

%-pmis.H: %-hol3.H %-msk3.H %-dip.H ${BINDIR}/Miss3.x %-band.p 
	< $*-hol3.H ${BINDIR}/Miss3.x nw=3 niter=200 \
	mask=$*-msk3.H dip=$*-dip.H | \
	Bandpass par=$*-band.p > $@

%-pdif.H: %-pmis.H %.H %-band.p
	< $*.H Bandpass par=$*-band.p > junk1.H
	Add scale=1,-1 $*-pmis.H junk1.H > junk2.H
	Cat $*-pmis.H junk.H > $@

%-pch3.H: %-dip.H ${BINDIR}/Patch3.x
	< $*-dip.H Window n4=1 f4=1 > q3.H
	< $*-dip.H Window n4=1 | \
	${BINDIR}/Patch3.x np=61 nq=61 pmax=4 qmax=4 q=q3.H > $@

bank5.H nh.H lag.H: ${BINDIR}/Filterbank5.x lage1.p
	${BINDIR}/Filterbank5.x np=61 nq=61 pmax=4 qmax=4 nh=nh.H lags=lag.H \
	nt=40 nx=40 niter=10 eps=0.0009 par=lage1.p > bank5.H

%-mis3.H: %-hol3.H %-msk3.H %-pch3.H bank5.H lag.H nh.H ${BINDIR}/NMiss.x
	< $*-hol3.H ${BINDIR}/NMiss.x niter=100 mask=$*-msk3.H \
	lag=lag.H nh=nh.H filt=bank5.H pch=$*-pch3.H > $@

%-rnd.H: %.H ${BINDIR}/Random3.x %-band.p
	< $*.H ${BINDIR}/Random3.x | Bandpass par=$*-band.p > $@

%-txt3.H: %-pch3.H %-rnd.H bank5.H lag.H nh.H ${BINDIR}/NHelicon.x
	< $*-rnd.H ${BINDIR}/NHelicon.x \
	lag=lag.H nh=nh.H adj=0 div=1 filt=bank5.H pch=$*-pch3.H > $@

pdome%.A: qdome-dip3.H
	< qdome-dip3.H Window n4=1 f4=$* | Byte gainpanel=each pclip=100 > $@

pdome0.v: pdome0.A
	< pdome0.A ${CUBE} color=j title="X slope" out=$@

pdome1.v: pdome1.A
	< pdome1.A ${CUBE} color=j title="Y slope" out=$@

udome%.A: qdome-dip.H
	< qdome-dip.H Window n4=1 f4=$* | Byte gainpanel=each pclip=100 > $@

udome0.v: udome0.A
	< udome0.A ${CUBE} color=j wantscalebar=y title="X slope" out=$@

udome1.v: udome1.A
	< udome1.A ${CUBE} color=j wantscalebar=y title="Y slope" out=$@

${RESDIR}/qslope.v ${RESDIR}/qslope.v3: pdome0.v pdome1.v udome0.v udome1.v
	vp_SideBySideAniso pdome0.v pdome1.v >pdome.v
	vp_SideBySideAniso udome0.v udome1.v >udome.v
	vp_OverUnderAniso pdome.v udome.v > ${RESDIR}/qslope.v
	vp_Movie pdome.v udome.v >  ${RESDIR}/qslope.v3

qdome.v: qdome.A
	< qdome.A ${CUBE} title="Qdome Model" out=$@

qhole.v: qdome-hol3.A
	< qdome-hol3.A ${CUBE} title="60% removed" out=$@

${RESDIR}/qdome.v: qdome.v qhole.v
	vp_SideBySideIso qdome.v qhole.v >$@

${RESDIR}/qmiss.v: qmiss.A qhole.v
	< qmiss.A ${CUBE} title="Interpolated" out=miss.v
	vp_SideBySideIso qhole.v miss.v >$@

qmiss.v: qdome-mis3.A 
	< qdome-mis3.A ${CUBE} title="Interpolated" out=qmiss.v

${RESDIR}/pmiss.v: qdome-pmis.A 
	< qdome-pmis.A ${CUBE} title="Interpolated" out=$@

pmiss.v: qdome-pdif.A
	< qdome-pdif.A Window n3=50 | ${CUBE} title="Interpolated" out=pint.v
	< qdome-pdif.A Window f3=50 | ${CUBE} title="Error" out=pdif.v
	vp_SideBySideAniso pint.v pdif.v > $@

qmiss%.v: qmiss%.A
	< qmiss$*.A ${CUBE} title="Interpolated" out=qmiss$*.v

spike%.H: spike%.p
	Spike par=spike$*.p > $@

mfilt%.H: ${BINDIR}/Plane5.x
	 ${BINDIR}/Plane5.x px=$* py=0.5 rhox=1 rhoy=1 \
	nt=40 nx=20 niter=10 eps=0.001 > $@

mlane%.H: mfilt%.H spike6.H 
	< spike6.H Helicon filt=mfilt$*.H div=1 adj=0 > junk1.H
	< junk1.H Bandpass fhi=0.25 > junk2.H
	< junk2.H  Helicon filt=mfilt$*.H div=1 adj=1 > $@

mlane%.v: mlane%.H
	< mlane$*.H Byte gainpanel=all | ${CUBE2} title="Px=$* Py=0.5" out=$@

${RESDIR}/cube.v ${RESDIR}/cube.v3: \
	mlane-2.v mlane-1.75.v mlane-1.5.v mlane-1.25.v \
	mlane-1.v mlane-0.75.v mlane-0.5.v mlane-0.25.v \
	mlane0.v \
	mlane0.25.v mlane0.5.v mlane0.75.v mlane1.v \
	mlane1.25.v mlane1.5.v mlane1.75.v mlane2.v
	vp_SideBySideIso mlane0.75.v mlane-0.75.v > ${RESDIR}/cube.v
	vp_Movie \
	mlane-2.v mlane-1.75.v mlane-1.5.v mlane-1.25.v \
	mlane-1.v mlane-0.75.v mlane-0.5.v mlane-0.25.v \
	mlane0.v \
	mlane0.25.v mlane0.5.v mlane0.75.v mlane1.v \
	mlane1.25.v mlane1.5.v mlane1.75.v mlane2.v > ${RESDIR}/cube.v3

#################### Constant velocity test #####################

cup.H: ${BINDIR}/Cup.x spike.p
	${BINDIR}/Cup.x par=spike.p | Bandpass flo=10 fhi=50 | \
	Transp | Bandpass fhi=50 | Transp >$@

${RESDIR}/cup.v: cup.H
	< cup.H ${OGREY} title=Model out=$@

data.%.H: %.H ${BINDIR}/PreConstKirch.x
	< $*.H Halfint inv=1 | \
	${BINDIR}/PreConstKirch.x zero=y inv=y \
	h0=0 dh=0.008 nh=61 vel=1.5 > $@
	echo "n4=1 o3=0 d3=0.008 n3=61" >> $@

nmo.%.H: data.%.H ${BINDIR}/ConstNMO.x
	< data.$*.H Transp plane=23 > data23.H
	< data23.H ${BINDIR}/ConstNMO.x v0=1.5  > data32.H
	< data32.H Transp plane=23 > $@

shot.%.H: nmo.%.H ${BINDIR}/Cmp2shot.x
	< nmo.$*.H Transp plane=23 | ${BINDIR}/Cmp2shot.x > $@

synshot.H: synnmod.H ${BINDIR}/Cmp2shot.x
	< synnmod.H ${TRANSP} plane=23 | ${BINDIR}/Cmp2shot.x > $@

beishot.H: beinmod.H ${BINDIR}/Cmp2shot2.x
	< beinmod.H ${TRANSP} plane=23 | ${BINDIR}/Cmp2shot2.x > $@

synshot3.H: synshot.H
	< synshot.H Window n3=3 f3=325 > $@

${RESDIR}/cupdata.v ${RESDIR}/cupdata.v3: nmo.cup.H cuphole.H
	< nmo.cup.H Window n3=1 f3=0  f1=50 n1=100 | \
	${OGREY} title="Zero offset" out=d1.v
	< nmo.cup.H Window n3=1 f3=25 f1=50 n1=100 | \
	${OGREY} title="Middle offset" out=d2.v
	< nmo.cup.H Window n3=1 f3=50 f1=50 n1=100 | \
	${OGREY} title="Far offset" out=d3.v
	vp_OverUnderAniso d1.v d2.v d3.v > d.v
	< cuphole.H Window n3=1 f3=0  f1=50 n1=100 | \
	${OGREY} title="Zero offset" out=n1.v
	< cuphole.H Window n3=1 f3=25 f1=50 n1=100 | \
	${OGREY} title="Middle offset" out=n2.v
	< cuphole.H Window n3=1 f3=50 f1=50 n1=100 | \
	${OGREY} title="Far offset" out=n3.v
	vp_OverUnderAniso n1.v n2.v n3.v > n.v
	vp_Movie d.v n.v > ${RESDIR}/cupdata.v3
	vp_SideBySideAniso d.v n.v > junk.v
	< junk.v vppen \
	vpstyle=n txscale=3 xsize=7.5 ysize=10 > ${RESDIR}/cupdata.v

${RESDIR}/tslice.v ${RESDIR}/tslice.v3: nmo.cup.H cuphole.H
	< nmo.cup.H Window n1=1 f1=74 | \
	${OGREY} transp=n title="t=0.3" label1=midpoint label2=offset out=t1.v
	< nmo.cup.H Window n1=1 f1=99 | \
	${OGREY} transp=n title="t=0.4" label1=midpoint label2=offset out=t2.v
	< nmo.cup.H Window n1=1 f1=124 | \
	${OGREY} transp=n title="t=0.5" label1=midpoint label2=offset out=t3.v
	vp_OverUnderAniso t1.v t2.v t3.v > t.v
	 < cuphole.H Window n1=1 f1=74 | \
	${OGREY} transp=n title="t=0.3" label1=midpoint label2=offset out=n1.v
	< cuphole.H Window n1=1 f1=99 | \
	${OGREY} transp=n title="t=0.4" label1=midpoint label2=offset out=n2.v
	< cuphole.H Window n1=1 f1=124 | \
	${OGREY} transp=n title="t=0.5" label1=midpoint label2=offset out=n3.v
	vp_OverUnderAniso n1.v n2.v n3.v > n.v
	vp_Movie t.v n.v > ${RESDIR}/tslice.v3
	vp_SideBySideAniso t.v n.v > junk.v
	< junk.v vppen \
	vpstyle=n txscale=3 xsize=7.5 ysize=10 > ${RESDIR}/tslice.v


cuphole.H mask.H: nmo.cup.H ${BINDIR}/Shotholes.x 
	< nmo.cup.H ${BINDIR}/Shotholes.x perc=0.9 >cuphole.H mask=mask.H

shothole.H: cuphole.H ${BINDIR}/Cmp2shot.x
	< cuphole.H Transp plane=23 | ${BINDIR}/Cmp2shot.x > $@

shotmask.H: mask.H ${BINDIR}/Cmp2shot.x
	< mask.H Transp plane=23 | Transp | Transp plane=23 | \
	${BINDIR}/Cmp2shot.x | Transp | Transp plane=23 > $@

#cuphole.H mask.H: nmo.cup.H ${BINDIR}/Holes.x 
#	< nmo.cup.H ${BINDIR}/Holes.x perc=0.9 >cuphole.H mask=mask.H

aftd.H: nmo.cup.H ${BINDIR}/Stretch.x ${BINDIR}/FFT1.x ${BINDIR}/Shift.x
	< nmo.cup.H Window f1=25 | \
	${BINDIR}/Stretch.x nout=256 | ${BINDIR}/FFT1.x > fft.H
	< fft.H ${BINDIR}/Shift.x | Transp | Transp plane=23 > $@

shotaftd.H: shot.cup.H ${BINDIR}/Stretch.x ${BINDIR}/FFT1.x ${BINDIR}/Shift.x
	< shot.cup.H Window f1=50 | \
	${BINDIR}/Stretch.x nout=256 | ${BINDIR}/FFT1.x > fft.H
	< fft.H ${BINDIR}/Shift.x | Transp | Transp plane=23 > $@

astck.H: aftd.H ${BINDIR}/Finstack.x
	< aftd.H ${BINDIR}/Finstack.x > $@

admo.H: aftd.H ${BINDIR}/Fincon.x
	< aftd.H Window n2=1 f2=60  | \
	${BINDIR}/Fincon.x h0=0.48 nh=1 dh=-0.008 > $@

astkd.H: astck.H nmo.cup.H ${BINDIR}/FFT2.x ${BINDIR}/Stretch.x
	< astck.H ${TRANSP} | ${BINDIR}/FFT2.x > junk1.H
	< junk1.H ${BINDIR}/Stretch.x inv=1 > junk2.H
	< nmo.cup.H Window n1=25 n3=1 > junk1.H
	Cat axis=1 junk1.H junk2.H > $@

admod.H: admo.H nmo.cup.H ${BINDIR}/FFT2.x ${BINDIR}/Stretch.x
	< admo.H ${TRANSP} plane=23 | ${TRANSP} | ${BINDIR}/FFT2.x > junk1.H
	< junk1.H ${BINDIR}/Stretch.x inv=1 > junk2.H
	< nmo.cup.H Window n1=25 > junk1.H
	Cat axis=1 junk1.H junk2.H > $@

admod1.H: admo.H nmo.cup.H ${BINDIR}/FFT2.x ${BINDIR}/Stretch.x
	< admo.H ${TRANSP} | ${BINDIR}/FFT2.x > junk1.H
	< junk1.H ${BINDIR}/Stretch.x inv=1 > junk2.H
	< nmo.cup.H Window n1=25 n3=1 > junk1.H
	Cat axis=1 junk1.H junk2.H > $@

astup.H: nmo.cup.H
	< nmo.cup.H ${TRANSP} plane=23 | Stack norm=no > $@

acc.H: aftd.H ${BINDIR}/Osmooth.x
	<  aftd.H ${BINDIR}/Osmooth.x eps=0.1 > $@

fftd.H: cuphole.H ${BINDIR}/Stretch.x ${BINDIR}/FFT1.x ${BINDIR}/Shift.x
	< cuphole.H Window f1=50 | \
	${BINDIR}/Stretch.x nout=256 | ${BINDIR}/FFT1.x > fft.H
	< fft.H ${BINDIR}/Shift.x | Transp | Transp plane=23 > $@

shotfftd.H: shothole.H ${BINDIR}/Stretch.x ${BINDIR}/FFT1.x ${BINDIR}/Shift.x
	< shothole.H Window f1=50 | \
	${BINDIR}/Stretch.x nout=256 | ${BINDIR}/FFT1.x > fft.H
	< fft.H ${BINDIR}/Shift.x | Transp | Transp plane=23 > $@

fill.H: fftd.H mask.H ${BINDIR}/Ofilp.x 
	< fftd.H ${BINDIR}/Ofilp.x known=mask.H niter=500 > $@

film.H: fftd.H mask.H ${BINDIR}/Ofilm.x 
	< fftd.H ${BINDIR}/Ofilm.x known=mask.H niter=500 ns=8 > $@

shotfill.H: shotfftd.H shotmask.H ${BINDIR}/Sfil.x 
	< shotfftd.H ${BINDIR}/Sfil.x known=shotmask.H niter=1000 > $@

hfill.H: fftd.H mask.H ${BINDIR}/Hfilp.x 
	< fftd.H ${BINDIR}/Hfilp.x known=mask.H niter=500 > $@

cfill.H: fftd.H mask.H ${BINDIR}/Ofilc.x acc.H 
	< fftd.H ${BINDIR}/Ofilc.x cc=acc.H known=mask.H niter=500 > $@

fftd%.H: fftd.H 
	< fftd.H Window n3=1 f3=$* > $@

ffil%.H: fftd%.H mask.H ${BINDIR}/Ofilp.x 
	< fftd$*.H ${BINDIR}/Ofilp.x known=mask.H niter=500 > $@

shotfftd%.H: shotfftd.H 
	< shotfftd.H Window n3=1 f3=$* > $@

shotaftd%.H: shotaftd.H 
	< shotaftd.H Window n3=1 f3=$* > $@

shot3.H: shotaftd.H
	< shotaftd.H Window n2=3 f2=78 > $@

${RESDIR}/shot3.v ${RESDIR}/shot3.v3: shot.cup.H simp.H
	< shot.cup.H Window n3=1 f3=78 | \
	${OGREY} label2=offset crowd1=0.85 title="shot 1" out=shot1.v
	< shot.cup.H Window n3=1 f3=79 | \
	${OGREY} label2=offset crowd1=0.85 title="shot 2" out=shot2.v
	< shot.cup.H Window n3=1 f3=80 | \
	${OGREY} label2=offset crowd1=0.85 title="shot 3" out=shot3.v
	< simp.H Byte pclip=99.5 > diff.A
	< diff.A Window n3=1 f3=0 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="(shot1+shot3)/2" out=diff1.v
	< diff.A Window n3=1 f3=1 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="error: (shot1+shot3)/2 - shot2" out=diff2.v
	vp_Movie shot1.v shot2.v shot3.v diff1.v diff2.v > ${RESDIR}/shot3.v3
	vppen vpstyle=n big=n gridnum=2,2 \
	< shot1.v shot3.v diff1.v diff2.v > ${RESDIR}/shot3.v

shotin%.H: shot3.H ${BINDIR}/Infill.x
	< shot3.H ${BINDIR}/Infill.x eps=$* > $@

shotex%.H: shot3.H ${BINDIR}/Inextr.x
	< shot3.H ${BINDIR}/Inextr.x eps=$* > $@

shotexmask.H:
	Spike n1=61 n2=1 > junk1.H
	Spike n1=61 n2=2 k1=-1 > junk2.H
	Cat axis=2 junk1.H junk2.H > $@

shotls.H: shot3.H shotexmask.H ${BINDIR}/Sfil.x 
	< shot3.H Window n2=1 | Transp plane=23 > shot1.H
	Spike n1=61 n2=2 n3=256 k1=-1 | Rtoc > junk2.H
	Cat axis=2 shot1.H junk2.H | \
	${BINDIR}/Sfil.x known=shotexmask.H niter=1000 > $@

shotfill%.H: shotfftd%.H shotmask.H ${BINDIR}/Sfil.x 
	< shotfftd$*.H ${BINDIR}/Sfil.x known=shotmask.H niter=1000 > $@

${RESDIR}/fslice.v ${RESDIR}/fslice.v3: fill.H fftd.H
	< fftd.H Window n3=1 f3=120 | Real | \
	${OGREY} pclip=99 title="frequency=5" \
	transp=n label1=midpoint label2=offset out=f1.v
	< fftd.H Window n3=1 f3=112 | Real | \
	${OGREY} pclip=99 title="frequency=10" \
	transp=n label1=midpoint label2=offset out=f2.v
	< fftd.H Window n3=1 f3=103 | Real | \
	${OGREY} pclip=99 title="frequency=15" \
	transp=n label1=midpoint label2=offset out=f3.v
	vp_OverUnderAniso f1.v f2.v f3.v > f.v
	< fill.H Window n3=1 f3=120 | Real | \
	${OGREY} pclip=99 title="frequency=5" \
	transp=n label1=midpoint label2=offset out=i1.v
	< fill.H Window n3=1 f3=112 | Real | \
	${OGREY} pclip=99 title="frequency=10" \
	transp=n label1=midpoint label2=offset out=i2.v
	< fill.H Window n3=1 f3=103 | Real | \
	${OGREY} pclip=99 title="frequency=15" \
	transp=n label1=midpoint label2=offset out=i3.v
	vp_OverUnderAniso i1.v i2.v i3.v > i.v
	vp_SideBySideAniso f.v i.v > junk.v
	vp_Movie f.v i.v > ${RESDIR}/fslice.v3
	< junk.v vppen vpstyle=n txscale=3 xsize=7.5 ysize=10 \
	> ${RESDIR}/fslice.v

${RESDIR}/gslice.v ${RESDIR}/gslice.v3: film.H fftd.H
	< fftd.H Window n3=1 f3=120 | Real | \
	${OGREY} pclip=99 title="frequency=5" \
	transp=n label1=midpoint label2=offset out=f1.v
	< fftd.H Window n3=1 f3=112 | Real | \
	${OGREY} pclip=99 title="frequency=10" \
	transp=n label1=midpoint label2=offset out=f2.v
	< fftd.H Window n3=1 f3=103 | Real | \
	${OGREY} pclip=99 title="frequency=15" \
	transp=n label1=midpoint label2=offset out=f3.v
	vp_OverUnderAniso f1.v f2.v f3.v > f.v
	< film.H Window n3=1 f3=120 | Real | \
	${OGREY} pclip=99 title="frequency=5" \
	transp=n label1=midpoint label2=offset out=i1.v
	< film.H Window n3=1 f3=112 | Real | \
	${OGREY} pclip=99 title="frequency=10" \
	transp=n label1=midpoint label2=offset out=i2.v
	< film.H Window n3=1 f3=103 | Real | \
	${OGREY} pclip=99 title="frequency=15" \
	transp=n label1=midpoint label2=offset out=i3.v
	vp_OverUnderAniso i1.v i2.v i3.v > i.v
	vp_SideBySideAniso f.v i.v > junk.v
	vp_Movie f.v i.v > ${RESDIR}/gslice.v3
	< junk.v vppen vpstyle=n txscale=3 xsize=7.5 ysize=10 \
	> ${RESDIR}/gslice.v

${RESDIR}/sslice.v ${RESDIR}/sslice.v3: shotfill.H shotfftd.H
	< shotfftd.H Window n3=1 f3=120 | Real | \
	${OGREY} pclip=99 title="frequency=5" \
	transp=n label1=midpoint label2=offset out=f1.v
	< shotfftd.H Window n3=1 f3=112 | Real | \
	${OGREY} pclip=99 title="frequency=10" \
	transp=n label1=midpoint label2=offset out=f2.v
	< shotfftd.H Window n3=1 f3=103 | Real | \
	${OGREY} pclip=99 title="frequency=15" \
	transp=n label1=midpoint label2=offset out=f3.v
	vp_OverUnderAniso f1.v f2.v f3.v > f.v
	< shotfill.H Window n3=1 f3=120 | Real | \
	${OGREY} pclip=99 title="frequency=5" \
	transp=n label1=midpoint label2=offset out=i1.v
	< shotfill.H Window n3=1 f3=112 | Real | \
	${OGREY} pclip=99 title="frequency=10" \
	transp=n label1=midpoint label2=offset out=i2.v
	< shotfill.H Window n3=1 f3=103 | Real | \
	${OGREY} pclip=99 title="frequency=15" \
	transp=n label1=midpoint label2=offset out=i3.v
	vp_OverUnderAniso i1.v i2.v i3.v > i.v
	vp_SideBySideAniso f.v i.v > junk.v
	vp_Movie f.v i.v > ${RESDIR}/sslice.v3
	< junk.v vppen vpstyle=n txscale=3 xsize=7.5 ysize=10 \
	> ${RESDIR}/sslice.v

${RESDIR}/hslice.v ${RESDIR}/hslice.v3: hfill.H fftd.H
	< fftd.H Window n3=1 f3=120 | Real | \
	${OGREY} pclip=99 title="frequency=5" \
	transp=n label1=midpoint label2=offset out=f1.v
	< fftd.H Window n3=1 f3=112 | Real | \
	${OGREY} pclip=99 title="frequency=10" \
	transp=n label1=midpoint label2=offset out=f2.v
	< fftd.H Window n3=1 f3=103 | Real | \
	${OGREY} pclip=99 title="frequency=15" \
	transp=n label1=midpoint label2=offset out=f3.v
	vp_OverUnderAniso f1.v f2.v f3.v > f.v
	< hfill.H Window n3=1 f3=120 | Real | \
	${OGREY} pclip=99 title="frequency=5" \
	transp=n label1=midpoint label2=offset out=i1.v
	< hfill.H Window n3=1 f3=112 | Real | \
	${OGREY} pclip=99 title="frequency=10" \
	transp=n label1=midpoint label2=offset out=i2.v
	< hfill.H Window n3=1 f3=103 | Real | \
	${OGREY} pclip=99 title="frequency=15" \
	transp=n label1=midpoint label2=offset out=i3.v
	vp_OverUnderAniso i1.v i2.v i3.v > i.v
	vp_SideBySideAniso f.v i.v > junk.v
	vp_Movie f.v i.v > ${RESDIR}/hslice.v3
	< junk.v vppen vpstyle=n txscale=3 xsize=7.5 ysize=10 \
	> ${RESDIR}/hslice.v

${RESDIR}/cslice.v ${RESDIR}/cslice.v3: cfill.H fftd.H
	< fftd.H Window n3=1 f3=120 | Real | \
	${OGREY} pclip=99 title="frequency=5" \
	transp=n label1=midpoint label2=offset out=f1.v
	< fftd.H Window n3=1 f3=112 | Real | \
	${OGREY} pclip=99 title="frequency=10" \
	transp=n label1=midpoint label2=offset out=f2.v
	< fftd.H Window n3=1 f3=103 | Real | \
	${OGREY} pclip=99 title="frequency=15" \
	transp=n label1=midpoint label2=offset out=f3.v
	vp_OverUnderAniso f1.v f2.v f3.v > f.v
	< cfill.H Window n3=1 f3=120 | Real | \
	${OGREY} pclip=99 title="frequency=5" \
	transp=n label1=midpoint label2=offset out=i1.v
	< cfill.H Window n3=1 f3=112 | Real | \
	${OGREY} pclip=99 title="frequency=10" \
	transp=n label1=midpoint label2=offset out=i2.v
	< cfill.H Window n3=1 f3=103 | Real | \
	${OGREY} pclip=99 title="frequency=15" \
	transp=n label1=midpoint label2=offset out=i3.v
	vp_OverUnderAniso i1.v i2.v i3.v > i.v
	vp_SideBySideAniso f.v i.v > junk.v
	vp_Movie f.v i.v > ${RESDIR}/cslice.v3
	< junk.v vppen vpstyle=n txscale=3 xsize=7.5 ysize=10 \
	> ${RESDIR}/cslice.v



fild.H: nmo.cup.H fill.H \
	${BINDIR}/Stretch.x ${BINDIR}/FFT2.x ${BINDIR}/Shift.x 
	< fill.H Transp plane=23 | Transp | \
	${BINDIR}/Shift.x inv=y> transp.H
	< transp.H ${BINDIR}/FFT2.x > finv.H
	< finv.H ${BINDIR}/Stretch.x dens=2 inv=1 > junk1.H
	< nmo.cup.H Window n1=50 > junk2.H
	Cat axis=1 junk2.H junk1.H > $@

fimd.H: nmo.cup.H film.H \
	${BINDIR}/Stretch.x ${BINDIR}/FFT2.x ${BINDIR}/Shift.x 
	< film.H Transp plane=23 | Transp | \
	${BINDIR}/Shift.x inv=y> transp.H
	< transp.H ${BINDIR}/FFT2.x > finv.H
	< finv.H ${BINDIR}/Stretch.x dens=2 inv=1 > junk1.H
	< nmo.cup.H Window n1=50 > junk2.H
	Cat axis=1 junk2.H junk1.H > $@

shotfild.H: shot.cup.H shotfill.H \
	${BINDIR}/Stretch.x ${BINDIR}/FFT2.x ${BINDIR}/Shift.x 
	< shotfill.H Transp plane=23 | Transp | \
	${BINDIR}/Shift.x inv=y> transp.H
	< transp.H ${BINDIR}/FFT2.x > finv.H
	< finv.H ${BINDIR}/Stretch.x dens=2 inv=1 > junk1.H
	< shot.cup.H Window n1=50 > junk2.H
	Cat axis=1 junk2.H junk1.H > $@

shotxd%.H: shot.cup.H shotex%.H \
	${BINDIR}/Stretch.x ${BINDIR}/FFT2.x ${BINDIR}/Shift.x 
	< shotex$*.H Transp ${BINDIR}/Shift.x inv=y> transp.H
	< transp.H ${BINDIR}/FFT2.x > finv.H
	< finv.H ${BINDIR}/Stretch.x dens=2 inv=1 > junk1.H
	< shot.cup.H Window n1=50 n3=1 f3=79 > junk2.H
	Cat axis=1 junk2.H junk1.H > $@

shotlsd.H: shot.cup.H shotls.H \
	${BINDIR}/Stretch.x ${BINDIR}/FFT2.x ${BINDIR}/Shift.x 
	< shotls.H Transp plane=23 | Transp | \
	${BINDIR}/Shift.x inv=y> transp.H
	< transp.H ${BINDIR}/FFT2.x > finv.H
	< finv.H ${BINDIR}/Stretch.x dens=2 inv=1 > junk1.H
	< shot.cup.H Window n1=50 n3=3 f3=78 > junk2.H
	Cat axis=1 junk2.H junk1.H > $@

shotnd%.H: shot.cup.H shotin%.H \
	${BINDIR}/Stretch.x ${BINDIR}/FFT2.x ${BINDIR}/Shift.x 
	< shotin$*.H Transp | ${BINDIR}/Shift.x inv=y> transp.H
	< transp.H ${BINDIR}/FFT2.x > finv.H
	< finv.H ${BINDIR}/Stretch.x dens=2 inv=1 > junk1.H
	< shot.cup.H Window n1=50 n3=1 f3=79 > junk2.H
	Cat axis=1 junk2.H junk1.H > $@

shotbench.H: shot.cup.H
	< shot.cup.H Window n3=1 f3=79 > $@

shotdiff%.H: shotnd%.H shotbench.H
	Add scale=1,-1 shotnd$*.H shotbench.H > diff.H
	Cat shotnd$*.H diff.H > $@

${RESDIR}/shotin.v: shotdiff0.H shotdiff0.5.H
	< shotdiff0.H Byte pclip=99.5 > diff1.A
	< shotdiff0.5.H Byte pclip=99.5 > diff2.A
	< diff1.A Window n3=1 f3=0 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="interpolated shot, no reg" out=shot1.v
	< diff1.A Window n3=1 f3=1 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="error, no reg" out=diff1.v
	< diff2.A Window n3=1 f3=0 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="interpolated shot, reg" out=shot2.v
	< diff2.A Window n3=1 f3=1 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="error, reg" out=diff2.v
	vppen vpstyle=n big=n gridnum=2,2 < \
	shot1.v diff1.v shot2.v diff2.v > ${RESDIR}/shotin.v

sfild.H: shotfild.H ${BINDIR}/Shot2cmp.x
	< shotfild.H ${BINDIR}/Shot2cmp.x > $@

hild.H: nmo.cup.H hfill.H \
	${BINDIR}/Stretch.x ${BINDIR}/FFT2.x ${BINDIR}/Shift.x 
	< hfill.H Transp plane=23 | Transp | \
	${BINDIR}/Shift.x inv=y> transp.H
	< transp.H ${BINDIR}/FFT2.x > finv.H
	< finv.H ${BINDIR}/Stretch.x dens=2 inv=1 > junk1.H
	< nmo.cup.H Window n1=50 > junk2.H
	Cat axis=1 junk2.H junk1.H > $@

all.H: nmo.cup.H cuphole.H hild.H fild.H fimd.H
	Merge axis=2 nmo.cup.H cuphole.H hild.H fild.H fimd.H > $@

all.v3: all.H
	< all.H Window f1=50 n1=100 > junk.H
	< junk.H Grey crowd=1 >/dev/null out=$@

${RESDIR}/all.v ${RESDIR}/all.v3: hild.H fild.H 
	< hild.H Window n3=1  f3=0 f1=50 n1=100 | \
	${OGREY} title="Near offset" out=h1.v
	< hild.H Window n3=1 f3=25 f1=50 n1=100 | \
	${OGREY} title="Middle offset" out=h2.v
	< hild.H Window n3=1 f3=50 f1=50 n1=100 | \
	${OGREY} title="Far offset" out=h3.v
	vp_OverUnderAniso h1.v h2.v h3.v > h.v
	< fild.H Window n3=1 f3=0  f1=50 n1=100 | \
	${OGREY} title="Near offset" out=f1.v
	< fild.H Window n3=1 f3=25 f1=50 n1=100 | \
	${OGREY} title="Middle offset" out=f2.v
	< fild.H Window n3=1 f3=50 f1=50 n1=100 | \
	${OGREY} title="Far offset" out=f3.v
	vp_OverUnderAniso f1.v f2.v f3.v > f.v
	vp_Movie h.v f.v > ${RESDIR}/all.v3
	vp_SideBySideAniso h.v f.v > junk.v
	< junk.v vppen \
	vpstyle=n txscale=3 xsize=7.5 ysize=10 > ${RESDIR}/all.v

################## Marmousi test #########################################

ELF = /net/kana/data_3d/elf_north_sea/data3950.H

elf.H: ${ELF} ${BINDIR}/Clip0.x ${BINDIR}/Zero.x
	< ${ELF} ${BINDIR}/Clip0.x clip=100000 > clip.H
	echo "d2=12.5 o2=50 hff=-1" >> clip.H
	< clip.H ${BINDIR}/Zero.x f2=67 f3=663 nt=300 > zero.H
	< zero.H Window n1=800 > $@

${RESDIR}/elf.v: elf.H
	< elf.H Window n2=1 f2=0 > near.H
	< elf.H Window n2=1 f2=119  > far.H
	< near.H ${OGREY} title="Near offset" out=near.v
	< far.H ${OGREY}  title="Far offset" out=far.v
	vp_SideBySideAniso near.v far.v > junk.v
	< junk.v vppen vpstyle=n xsize=12 ysize=6 > $@

${RESDIR}/marm.v: ${MARMDIR}/marmrefl.H
	< ${MARMDIR}/marmrefl.H Window n2=1 f2=95 > near.H
	< ${MARMDIR}/marmrefl.H Window n2=1 f2=0  > far.H
	< near.H ${OGREY} title="Near offset" out=near.v
	< far.H ${OGREY}  title="Far offset" out=far.v
	vp_SideBySideAniso near.v far.v > junk.v
	< junk.v vppen vpstyle=n xsize=12 ysize=6 > $@

marmcmp.H: ${MARMDIR}/marmrefl.H ${BINDIR}/Shot2cmp.x
	< ${MARMDIR}/marmrefl.H Reverse which=2 | ${BINDIR}/Shot2cmp.x > $@

marmpad.H: marmcmp.H
	< marmcmp.H Reverse which=2 | Pad n2out=104 | Reverse which=2 > $@

marmshot.H: marmpad.H ${BINDIR}/Cmp2shot.x
	< marmpad.H ${BINDIR}/Cmp2shot.x > $@

mshot%.H: marmshot.H ${BINDIR}/Extractshot.x
	< marmshot.H ${BINDIR}/Extractshot.x is=$* > $@

marmint.H: marmfild.H ${BINDIR}/Cmp2shot.x
	< marmfild.H ${BINDIR}/Cmp2shot.x > $@

ishot%.H: marmint.H ${BINDIR}/Extractshot.x ${BINDIR}/Mutter.x
	< marmint.H ${BINDIR}/Extractshot.x is=$* | \
	${BINDIR}/Mutter.x tp=0.001 slope0=0.001 > $@

${RESDIR}/mshot.v ${RESDIR}/mshot.v3: mshot224.H ishot224.H
	< mshot224.H ${OGREY} pclip=99 title=Input out=m.v
	< ishot224.H ${OGREY} pclip=99 title=Interpolated out=i.v
	vp_Movie m.v i.v > ${RESDIR}/mshot.v3
	vp_OverUnderAniso m.v i.v > junk.v
	< junk.v vppen vpstyle=n xsize=7.5 ysize=10 > ${RESDIR}/mshot.v

${RESDIR}/mishot.v: ishot225.H
	< ishot224.H ${OGREY} pclip=99 title=Interpolated out=i.v
	< i.v vppen vpstyle=n xsize=7.5 ysize=5 > $@

mcmp%.H: marmpad.H
	< marmpad.H Window n3=1 f3=$* > cmp.H
	< cmp.H Reverse which=2 | Window n2=103 > rcmp.H
	Cat rcmp.H cmp.H axis=2 > $@

icmp%.H: marmfild.H ${BINDIR}/Mutter.x
	< marmfild.H Window n3=1 f3=$* > cmp.H
	< cmp.H Reverse which=2 | Window n2=103 > rcmp.H
	Cat rcmp.H cmp.H axis=2 | ${BINDIR}/Mutter.x tp=0.001 slope0=0.001 > $@

${RESDIR}/mcmp.v ${RESDIR}/mcmp.v3: mcmp224.H icmp224.H
	< mcmp224.H ${OGREY} pclip=99 title=Input out=m.v
	< icmp224.H ${OGREY} pclip=99 title=Interpolated out=i.v
	vp_Movie m.v i.v > ${RESDIR}/mcmp.v3
	vp_OverUnderAniso m.v i.v > junk.v
	< junk.v vppen vpstyle=n xsize=7.5 ysize=10 > ${RESDIR}/mcmp.v

marmmask.H: marmpad.H ${BINDIR}/Holes.x
	<marmpad.H ${BINDIR}/Holes.x perc=0 >junks.H mask=junkmask.H
	<junkmask.H Transp > $@

marmnmo.H: marmpad.H ${BINDIR}/ConstNMO.x marm.p 
	< marmpad.H ${BINDIR}/ConstNMO.x par=marm.p > marmnmo.H	

elfnmo.H: elf.H ${BINDIR}/ConstNMO.x elf.p 
	< elf.H ${BINDIR}/ConstNMO.x par=elf.p > $@

marmsmb.H: marmnmo.H ${BINDIR}/Vscan.x marm.p 
	< marmnmo.H ${BINDIR}/Vscan.x par=marm.p semblance=y > $@

elfsmb.H: elfnmo.H ${BINDIR}/Vscan.x elf.p 
	< elfnmo.H ${BINDIR}/Vscan.x par=elf.p semblance=y > $@

marmvpk.H: marmsmb.H ${BINDIR}/Blindpick.x
	< marmsmb.H Reverse which=2 | \
	${BINDIR}/Blindpick.x eps=0.1 lam=0.1 | \
	${TRANSP} plane=23 > $@

marmnmod.H: marmpad.H ${DATADIR}/marmvel.H ${BINDIR}/NMO.x ${BINDIR}/Mutter.x
	<  marmpad.H ${BINDIR}/Mutter.x slope0=0.0018 > marmmut.H
	< marmmut.H ${BINDIR}/NMO.x vel=${DATADIR}/marmvel.H > $@

beinmod.H: ${DATADIR}/bei.H ${DATADIR}/beivel.H \
	${BINDIR}/NMO.x ${BINDIR}/Mutter.x
	< ${DATADIR}/bei.H Transp plane=23 > bei23.H
	< bei23.H ${BINDIR}/Mutter.x slope0=1.4 > beimut.H
	< beimut.H ${BINDIR}/NMO.x vel=${DATADIR}/beivel.H > bei23.H
	< bei23.H Transp plane=23 > $@

elfnmod.H: elf.H ${DATADIR}/elfvel.H ${BINDIR}/NMO.x 
	< elf.H ${BINDIR}/NMO.x vel=${DATADIR}/elfvel.H > $@

elfhole.H elfmask.H: elfnmod.H ${BINDIR}/Shotholes.x 
	< elfnmod.H ${BINDIR}/Shotholes.x perc=0.6 > elfhole.H mask=junke.H
	< junke.H ${TRANSP} > elfmask.H

elfshot.H: elfnmod.H ${BINDIR}/Cmp2shot.x
	< elfnmod.H ${BINDIR}/Cmp2shot.x > $@

elfshot3.H: elfshot.H
	< elfshot.H Window n3=3 f3=800 > $@

elfsimp.H: elfshot3.H
	< elfshot3.H Window n3=1 f3=0 > junk1.H
	< elfshot3.H Window n3=1 f3=1 > junk2.H
	< elfshot3.H Window n3=1 f3=2 > junk3.H
	Add junk1.H junk3.H | Scale dscale=0.5 > junk4.H
	Add scale=1,-1 junk4.H junk2.H > junk5.H
	Cat junk4.H junk5.H > $@

marmsimp.H: marmshot3.H
	< marmshot3.H Window n3=1 f3=0 > junk1.H
	< marmshot3.H Window n3=1 f3=1 > junk2.H
	< marmshot3.H Window n3=1 f3=2 > junk3.H
	Add junk1.H junk3.H | Scale dscale=0.5 > junk4.H
	Add scale=1,-1 junk4.H junk2.H > junk5.H
	Cat junk4.H junk5.H > $@

simp.H: shot.cup.H
	< shot.cup.H Window n3=1 f3=78 > junk1.H
	< shot.cup.H Window n3=1 f3=79 > junk2.H
	< shot.cup.H Window n3=1 f3=80 > junk3.H
	Add junk1.H junk3.H | Scale dscale=0.5 > junk4.H
	Add scale=1,-1 junk4.H junk2.H > junk5.H
	Cat junk4.H junk5.H > $@

synnmod.H: ${DATADIR}/synth.H ${DATADIR}/synvel.H \
	${BINDIR}/NMO.x ${BINDIR}/Mutter.x
	< ${DATADIR}/synth.H Transp plane=23 > syn23.H
	echo "d2=0.032" >> syn23.H
	< syn23.H ${BINDIR}/Mutter.x slope0=0.7 mute=no > synmut.H
	< synmut.H ${BINDIR}/NMO.x vel=${DATADIR}/synvel.H > syn23.H
	< syn23.H Transp plane=23 > $@

marmshots.H: marmnmod.H ${BINDIR}/Cmp2shot.x
	< marmnmod.H ${BINDIR}/Cmp2shot.x > junk.H
	< junk.H Window f3=103 j3=2 n3=240 f2=8 > $@

marmffts.H: marmshots.H ${BINDIR}/Stretch.x ${BINDIR}/FFT1.x
	< marmshots.H Window f1=10 | ${BINDIR}/Stretch.x nout=4096 > junkms.H
	< junkms.H ${BINDIR}/FFT1.x > ffts.H
	< ffts.H ${TRANSP} > junkms.H
	< junkms.H ${TRANSP} plane=23 > $@
	Rm junkms.H

marmfills.H: marmffts.H ${BINDIR}/Shotfill.x
	< marmffts.H ${BINDIR}/Shotfill.x > $@

marmfilds.H: marmfills.H ${BINDIR}/Stretch.x ${BINDIR}/FFT2.x marmshots.H
	< marmfills.H ${TRANSP} plane=23 > junkms.H
	< junkms.H ${TRANSP} > ffts.H
	< ffts.H ${BINDIR}/FFT2.x > junkms.H
	< junkms.H ${BINDIR}/Stretch.x inv=1 > junk1.H
	< marmshots.H Window n1=10 > junk2.H
	Cat junk2.H junk2.H > junk3.H
	Cat axis=1 junk3.H junk1.H > $@

marmshot3.H: marmshots.H ${BINDIR}/Mutter.x
	< marmshots.H Window n3=3 f3=63 | \
	${BINDIR}/Mutter.x slope0=0.0012 > $@

${RESDIR}/marmshot3.v ${RESDIR}/marmshot3.v3: marmshot3.H
	< marmshot3.H Window n3=1 f3=0 | \
	${OGREY} label2=offset crowd1=0.85 title="Shot 1" out=shot1.v
	< marmshot3.H Window n3=1 f3=1 | \
	${OGREY} label2=offset crowd1=0.85 title="Shot 2" out=shot2.v
	< marmshot3.H Window n3=1 f3=2 | \
	${OGREY} label2=offset crowd1=0.85 title="Shot 3" out=shot3.v
	vp_Movie shot1.v  shot2.v shot3.v > ${RESDIR}/marmshot3.v3
	vp_OverUnderAniso shot1.v shot3.v > ${RESDIR}/marmshot3.v

marmstrd.H: marmnmod.H ${BINDIR}/Stretch.x
	< marmnmod.H Window f1=10 | ${BINDIR}/Stretch.x nout=4096 > $@

beistrd.H: beinmod.H ${BINDIR}/Stretch.x
	< beinmod.H Window f1=15 | \
	${BINDIR}/Stretch.x nout=2048 > $@

synstrd.H: synnmod.H ${BINDIR}/Stretch.x
	< synnmod.H Window f1=50 | ${BINDIR}/Stretch.x nout=512 > $@

elfstrd.H: elfhole.H ${BINDIR}/Stretch.x
	< elfhole.H Window f1=20 | ${TRANSP} plane=23 | \
	${BINDIR}/Stretch.x nout=2048 > $@

marmstrd3.H: marmshot3.H ${BINDIR}/Stretch.x
	< marmshot3.H Window f1=10 | ${BINDIR}/Stretch.x nout=4096 > $@

synstrd3.H: synshot3.H ${BINDIR}/Stretch.x
	< synshot3.H Window f1=50 | ${BINDIR}/Stretch.x nout=512 > $@

elfstrd3.H: elfshot3.H ${BINDIR}/Stretch.x
	< elfshot3.H Window f1=20 | ${BINDIR}/Stretch.x nout=2048 > $@

marmfftd.H: ${BINDIR}/FFT1.x marmstrd.H
	< marmstrd.H ${BINDIR}/FFT1.x > junkm.H
	< junkm.H ${TRANSP} plane=31 > $@
	Rm junkm.H

beifftd.H: ${BINDIR}/FFT1.x beistrd.H
	< beistrd.H ${BINDIR}/FFT1.x > junkb.H
	< junkb.H ${TRANSP} > junkb1.H
	Rm junkb.H
	< junkb1.H ${TRANSP} plane=23 > $@
	Rm junkb1.H

elffftd.H: ${BINDIR}/FFT1.x elfstrd.H
	< elfstrd.H Window n2=500 | ${BINDIR}/FFT1.x > junke1.H
	< elfstrd.H Window f2=500 | ${BINDIR}/FFT1.x > junke2.H
	< junke1.H ${TRANSP} > junke3.H
	< junke3.H ${TRANSP} plane=23 > junke1.H
	< junke2.H ${TRANSP} > junke3.H
	< junke3.H ${TRANSP} plane=23 > junke2.H
	Rm junke3.H
	Cat axis=1 junke1.H junke2.H > elffftd.H

elffill.H: elffftd.H elfmask.H ${BINDIR}/Ofilp.x
	< elffftd.H ${BINDIR}/Ofilp.x known=elfmask.H niter=200 > $@

elfhill.H: elffftd.H elfmask.H ${BINDIR}/Hfilp.x
	< elffftd.H ${BINDIR}/Hfilp.x known=elfmask.H niter=200 > $@

elffinv.H: ${BINDIR}/FFT2.x elffill.H
	< elffill.H Window n1=500 > junke3.H
	< junke3.H ${TRANSP} plane=23 > junke1.H
	< junke1.H ${TRANSP} > junke3.H
	< junke3.H ${BINDIR}/FFT2.x > junke1.H
	< elffill.H Window f1=500 > junke3.H
	< junke3.H ${TRANSP} plane=23 > junke2.H
	< junke2.H ${TRANSP} > junke3.H
	< junke3.H ${BINDIR}/FFT2.x > junke2.H
	Rm junke3.H
	Cat axis=2 junke1.H junke2.H > $@

elfhinv.H: ${BINDIR}/FFT2.x elfhill.H
	< elfhill.H Window n1=500 > junkg3.H
	< junkg3.H ${TRANSP} plane=23 > junkg1.H
	< junkg1.H ${TRANSP} > junkg3.H
	< junkg3.H ${BINDIR}/FFT2.x > junkg1.H
	< elfhill.H Window f1=500 > junkg3.H
	< junkg3.H ${TRANSP} plane=23 > junkg2.H
	< junkg2.H ${TRANSP} > junkg3.H
	< junkg3.H ${BINDIR}/FFT2.x > junkg2.H
	Rm junkg3.H
	Cat axis=2 junkg1.H junkg2.H > $@

elffild.H: elffinv.H ${BINDIR}/Stretch.x elfhole.H
	< elffinv.H ${BINDIR}/Stretch.x inv=1 | \
	${TRANSP} plane=23 > junke2.H
	< elfhole.H Window n1=20 > junke1.H 
	Cat axis=1 junke1.H junke2.H > $@

elfhild.H: elfhinv.H ${BINDIR}/Stretch.x elfhole.H
	< elfhinv.H ${BINDIR}/Stretch.x inv=1 | \
	${TRANSP} plane=23 > junkg2.H
	< elfhole.H Window n1=20 > junkg1.H 
	Cat axis=1 junkg1.H junkg2.H > $@

beistrm.H: beistrd.H
	< beistrd.H Reverse which=4 | Pad n3=26 | Reverse which=4 > $@

beimask.H: beistrm.H ${BINDIR}/Holes.x
	<beistrm.H ${BINDIR}/Holes.x perc=0 >junkb.H mask=$@

beifftm.H: ${BINDIR}/FFT1.x beistrm.H
	< beistrm.H ${BINDIR}/FFT1.x > junkb.H
	< junkb.H ${TRANSP} > junkb1.H
	Rm junkb.H
	< junkb1.H ${TRANSP} plane=23 > $@
	Rm junkb1.H

synfftd.H: ${BINDIR}/FFT1.x ${BINDIR}/Shift.x synstrd.H
	< synstrd.H ${BINDIR}/FFT1.x > junks.H
	< junks.H ${TRANSP} > junks1.H
	Rm junks.H
	< junks1.H ${TRANSP} plane=23 > $@
	Rm junks1.H

beistck.H: beifftd.H ${BINDIR}/Finstack.x
	< beifftd.H ${BINDIR}/Finstack.x > $@

elfstck.H: elffftd.H ${BINDIR}/Finstack.x
	< elffftd.H ${BINDIR}/Finstack.x > $@

beistcm.H: beifftm.H ${BINDIR}/Ofilm.x beimask.H
	< beifftm.H ${BINDIR}/Ofilm.x \
	niter=100 known=beimask.H ns=24 zmin=3 > $@

synstck.H: synfftd.H ${BINDIR}/Finstack.x
	< synfftd.H ${BINDIR}/Finstack.x > $@

beistup.H: beinmod.H
	< beinmod.H ${TRANSP} plane=23 | Stack norm=no > $@

synstup.H: synnmod.H
	< synnmod.H ${TRANSP} plane=23 | Stack norm=no > $@

elfstup.H: elfnmod.H
	< elfnmod.H Stack norm=no > $@

marmfftd3.H: ${BINDIR}/FFT1.x ${BINDIR}/Shift.x marmstrd3.H
	< marmstrd3.H ${BINDIR}/FFT1.x > junkm0.H
	< junkm0.H ${BINDIR}/Shift.x > junkm1.H
	< junkm1.H ${TRANSP} | ${TRANSP} plane=23 > $@

synfftd3.H: ${BINDIR}/FFT1.x synstrd3.H
	< synstrd3.H ${BINDIR}/FFT1.x > junks1.H
	< junks1.H ${TRANSP} | ${TRANSP} plane=23 > $@

elffftd3.H: ${BINDIR}/FFT1.x elfstrd3.H
	< elfstrd3.H ${BINDIR}/FFT1.x > junke1.H
	< junke1.H ${TRANSP} | ${TRANSP} plane=23 > $@

marmshin%.H: marmfftd3.H ${BINDIR}/Infill.x
	< marmfftd3.H ${BINDIR}/Infill.x eps=$* > $@

synshin%.H: synfftd3.H ${BINDIR}/Infill.x
	< synfftd3.H ${BINDIR}/Infill.x eps=$* > $@

elfshin%.H: elffftd3.H ${BINDIR}/Infill.x
	< elffftd3.H ${BINDIR}/Infill.x eps=$* > $@

marmshnd%.H: marmshot3.H marmshin%.H \
	${BINDIR}/Stretch.x ${BINDIR}/FFT2.x ${BINDIR}/Shift.x 
	< marmshin$*.H Transp | ${BINDIR}/Shift.x inv=y> transp.H
	< transp.H ${BINDIR}/FFT2.x > finv.H
	< finv.H ${BINDIR}/Stretch.x inv=1 > junk1.H
	< marmshot3.H Window n1=10 n3=1 f3=1 > junk2.H
	Cat axis=1 junk2.H junk1.H > $@

synshnd%.H: synshot3.H synshin%.H \
	${BINDIR}/Stretch.x ${BINDIR}/FFT2.x ${BINDIR}/Shift.x 
	< synshin$*.H Transp | ${BINDIR}/Shift.x inv=y> transp.H
	< transp.H ${BINDIR}/FFT2.x > finv.H
	< finv.H ${BINDIR}/Stretch.x inv=1 > junk1.H
	< synshot3.H Window n1=50 n3=1 f3=1 > junk2.H
	Cat axis=1 junk2.H junk1.H > $@

elfshnd%.H: elfshot3.H elfshin%.H \
	${BINDIR}/Stretch.x ${BINDIR}/FFT2.x ${BINDIR}/Shift.x 
	< elfshin$*.H Transp | ${BINDIR}/Shift.x inv=y> transp.H
	< transp.H ${BINDIR}/FFT2.x > finv.H
	< finv.H ${BINDIR}/Stretch.x inv=1 > junk1.H
	< elfshot3.H Window n1=20 n3=1 f3=1 > junk2.H
	Cat axis=1 junk2.H junk1.H > $@

marmbench.H: marmshot3.H
	< marmshot3.H Window n3=1 f3=1 > $@

marmdiff%.H: marmshnd%.H marmbench.H
	Add scale=1,-1 marmshnd$*.H marmbench.H > junk.H
	Cat marmshnd$*.H junk.H > $@

synbench.H: synshot3.H
	< synshot3.H Window n3=1 f3=1 > $@

syndiff%.H: synshnd%.H synbench.H
	Add scale=1,-1 synshnd$*.H synbench.H > junk.H
	Cat synshnd$*.H junk.H > $@

elfbench.H: elfshot3.H
	< elfshot3.H Window n3=1 f3=1 > $@

elfdiff%.H: elfshnd%.H elfbench.H
	Add scale=1,-1 elfshnd$*.H elfbench.H > junk.H
	Cat elfshnd$*.H junk.H > $@

${RESDIR}/synshot3.v ${RESDIR}/synshot3.v3: synshot3.H
	< synshot3.H Window n3=1 f3=0 | \
	${OGREY} label2=offset crowd1=0.85 title="Shot 1" out=shot1.v
	< synshot3.H Window n3=1 f3=1 | \
	${OGREY} label2=offset crowd1=0.85 title="Shot 2" out=shot2.v
	< synshot3.H Window n3=1 f3=2 | \
	${OGREY} label2=offset crowd1=0.85 title="Shot 3" out=shot3.v
	vp_Movie shot1.v shot2.v shot3.v > ${RESDIR}/synshot3.v3
	vppen vpstyle=n big=n gridnum=2,1 \
	< shot1.v shot3.v > ${RESDIR}/synshot3.v

${RESDIR}/synshotin.v: syndiff0.H syndiff2.H
	< syndiff0.H Byte pclip=99.5 > diff1.A
	< syndiff2.H Byte pclip=99.5 > diff2.A
	< diff1.A Window n3=1 f3=0 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="interpolated shot, no reg" out=shot1.v
	< diff1.A Window n3=1 f3=1 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="error, no reg" out=diff1.v
	< diff2.A Window n3=1 f3=0 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="interpolated shot, reg" out=shot2.v
	< diff2.A Window n3=1 f3=1 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="error, reg" out=diff2.v
	vppen vpstyle=n big=n gridnum=2,2 < \
	shot1.v diff1.v shot2.v diff2.v > $@

${RESDIR}/elfshot3.v ${RESDIR}/elfshot3.v3: elfshot3.H
	< elfshot3.H Window n3=1 f3=0 | \
	${OGREY} label2=offset crowd1=0.85 title="Shot 1" out=shot1.v
	< elfshot3.H Window n3=1 f3=1 | \
	${OGREY} label2=offset crowd1=0.85 title="Shot 2" out=shot2.v
	< elfshot3.H Window n3=1 f3=2 | \
	${OGREY} label2=offset crowd1=0.85 title="Shot 3" out=shot3.v
	vp_Movie shot1.v shot2.v shot3.v > ${RESDIR}/elfshot3.v3
	vppen vpstyle=n big=n gridnum=2,1 \
	< shot1.v shot3.v > ${RESDIR}/elfshot3.v

elfsimp.v: elfsimp.H
	< elfsimp.H Window f1=400 | Byte pclip=99.5 > diff.A
	< diff.A Window n3=1 f3=0 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="(shot1+shot3)/2" out=diff1.v
	< diff.A Window n3=1 f3=1 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="error: (shot1+shot3)/2 - shot2" out=diff2.v
	vppen vpstyle=n big=n gridnum=2,1 < diff1.v diff2.v > $@

${RESDIR}/elfshotin.v: elfdiff1.3.H elfsimp.H
	< elfdiff1.3.H Window f1=400 n3=1 f3=0 | Grey clip=8973 >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="interpolated shot" out=shot.v
	< elfdiff1.3.H Window f1=400 n3=1 f3=1 | Grey clip=8973 >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="error" out=diff.v
	< elfsimp.H Window f1=400 n3=1 f3=0 | Grey clip=8973 >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="(shot1+shot3)/2" out=diff1.v
	< elfsimp.H Window f1=400 n3=1 f3=1 | Grey clip=8973 >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="error: (shot1+shot3)/2 - shot2" out=diff2.v
	vppen vpstyle=n big=n gridnum=2,2 < shot.v diff.v diff1.v diff2.v > $@

${RESDIR}/marmshotin.v: marmdiff2.H marmsimp.H 
	< marmdiff2.H Byte clip=2706 > diff.A
	< diff.A Window n3=1 f3=0 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="interpolated shot" out=shot.v
	< diff.A Window n3=1 f3=1 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="error: interpolated shot - shot2" out=diff.v
	< marmsimp.H Byte clip=2706 > diff.A
	< diff.A Window n3=1 f3=0 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="(shot1+shot3)/2" out=diff1.v
	< diff.A Window n3=1 f3=1 | Ta2vplot >/dev/null \
	label1=time label2=offset crowd1=0.85 \
	title="error: (shot1+shot3)/2 - shot2" out=diff2.v
	vppen vpstyle=n big=n gridnum=2,2 \
	 < shot.v diff.v diff1.v diff2.v > $@

fslice%.H: marmfftd.H ${BINDIR}/Average.x
	< marmfftd.H Window n3=1 f3=$* | ${BINDIR}/Average.x > $@

mfill%.H: marmfill.H
	< marmfill.H Window n3=1 f3=$* > $@

${RESDIR}/mslice.v ${RESDIR}/mslice.v3: \
	fslice2005.H fslice1962.H fslice1919.H \
	mfill2005.H mfill1962.H mfill1919.H
	< fslice2005.H Real | ${OGREY} pclip=99 title="frequency=10" \
	transp=n label1=midpoint label2=offset out=f1.v
	< fslice1962.H Real | ${OGREY} pclip=99 title="frequency=20" \
	transp=n label1=midpoint label2=offset out=f2.v
	< fslice1919.H Real | ${OGREY} pclip=99 title="frequency=30" \
	transp=n label1=midpoint label2=offset out=f3.v
	vp_OverUnderAniso f1.v f2.v f3.v > f.v
	< mfill2005.H Real | ${OGREY} pclip=99 title="frequency=10" \
	transp=n label1=midpoint label2=offset out=i1.v
	< mfill1962.H Real | ${OGREY} pclip=99 title="frequency=20" \
	transp=n label1=midpoint label2=offset out=i2.v
	< mfill1919.H Real | ${OGREY} pclip=99 title="frequency=30" \
	transp=n label1=midpoint label2=offset out=i3.v
	vp_OverUnderAniso i1.v i2.v i3.v > i.v
	vp_SideBySideAniso f.v i.v > junk.v
	vp_Movie f.v i.v > ${RESDIR}/mslice.v3
	< junk.v vppen vpstyle=n txscale=3 xsize=7.5 ysize=10 \
	> ${RESDIR}/mslice.v

marmfill.H: marmfftd.H marmmask.H ${BINDIR}/Ofilp.x 
	< marmfftd.H ${BINDIR}/Ofilp.x known=marmmask.H niter=200 >$@

marmfinv.H: marmfill.H ${BINDIR}/FFT2.x ${BINDIR}/Shift.x
	< marmfill.H ${TRANSP} plane=31 > junkm2.H
	< junkm2.H ${BINDIR}/Shift.x inv=y > junkm0.H
	Rm junkm2.H
	< junkm0.H ${BINDIR}/FFT2.x > $@
	Rm junkm0.H

beistkd.H: beistck.H beinmod.H ${BINDIR}/FFT2.x ${BINDIR}/Stretch.x
	< beistck.H ${TRANSP} > junkb0.H
	< junkb0.H ${BINDIR}/FFT2.x > junkb1.H
	< junkb1.H ${BINDIR}/Stretch.x inv=1 > junk1.H
	< beinmod.H Window n1=15 n3=1 > junk2.H
	Cat axis=1 junk2.H junk1.H > $@

elfstkd.H: elfstck.H elfnmod.H ${BINDIR}/FFT2.x ${BINDIR}/Stretch.x
	< elfstck.H ${TRANSP} > junke0.H
	< junke0.H ${BINDIR}/FFT2.x > junke1.H
	< junke1.H ${BINDIR}/Stretch.x inv=1 > junk1.H
	< elfnmod.H Window n1=20 n2=1 > junk2.H
	Cat axis=1 junk2.H junk1.H > $@

beistkm.H: beistcm.H beinmod.H ${BINDIR}/FFT2.x ${BINDIR}/Stretch.x
	< beistcm.H Window n2=1 f2=1 | ${TRANSP} > junkb0.H
	< junkb0.H ${BINDIR}/FFT2.x > junkb1.H
	< junkb1.H ${BINDIR}/Stretch.x inv=1 > junk1.H
	< beinmod.H Window n1=15 n3=1 > junk2.H
	Cat axis=1 junk2.H junk1.H > $@

synstkd.H: synstck.H synnmod.H ${BINDIR}/FFT2.x ${BINDIR}/Stretch.x
	< synstck.H ${TRANSP} > junks0.H
	< junks0.H ${BINDIR}/FFT2.x > junks1.H
	< junks1.H ${BINDIR}/Stretch.x inv=1 > junk1.H
	< synnmod.H Window n1=50 n3=1 > junk2.H
	Cat axis=1 junk2.H junk1.H > $@

beiagcd.H: beistkd.H
	< beistkd.H Smooth rect1=250 agc=1 > $@

beisgcd.H: beistup.H
	< beistup.H Smooth rect1=250 agc=1 > $@

${RESDIR}/beistack.v ${RESDIR}/beistack.v3: beistkd.H beistup.H
	< beistkd.H Tpow tpow=-0.5 | ${OGREY} title="OC Stack" out=ostack.v
	< beistup.H Tpow tpow=-0.5 | ${OGREY} title="NMO Stack" out=sstack.v
	vp_Movie sstack.v ostack.v > ${RESDIR}/beistack.v3
	vp_OverUnderAniso sstack.v ostack.v > ${RESDIR}/beistack.v

marmfild.H: marmfinv.H marmnmod.H \
	${BINDIR}/Stretch.x ${BINDIR}/NMO.x marmvpk.H 
	< marmfinv.H ${BINDIR}/Stretch.x inv=1 > junk1.H
	< marmnmod.H Window n1=10 > junk2.H
	Cat axis=1 junk2.H junk1.H > junk3.H
	< junk3.H ${BINDIR}/NMO.x vel=marmvpk.H inv=1 > $@

marmavg.H: marmnmod.H ${BINDIR}/Average2.x
	< marmnmod.H ${BINDIR}/Average2.x > $@

marmbak.H: marmavg.H ${BINDIR}/NMO.x marmvpk.H \
	${BINDIR}/Average2.x ${BINDIR}/Mutter.x
	< marmvpk.H ${BINDIR}/Average2.x > marmvbk.H
	< marmavg.H ${BINDIR}/NMO.x vel=marmvbk.H inv=y | \
	${BINDIR}/Mutter.x slope0=0.0014 > $@


#################### B-spline ##############################################

splan2_%.H: ${BINDIR}/Splineplane.x
	${BINDIR}/Splineplane.x p=$* eps=0.0001 nw=2 > $@

splan3_%.H: ${BINDIR}/Splineplane.x
	${BINDIR}/Splineplane.x p=$* eps=0.0001 nw=3 > $@

splan4_%.H: ${BINDIR}/Splineplane.x
	${BINDIR}/Splineplane.x p=$* eps=0.0001 nw=4 > $@

sthree%.H: splan%_0.7.H splan%_-1.H splan%_-0.1.H ${BINDIR}/Splinefilter.x \
	spike1.H spike2.H spike3.H
	< spike1.H Helicon div=1 filt=splan$*_0.7.H  > pl1.H
	< spike2.H Helicon div=1 filt=splan$*_-1.H   > pl2.H
	< spike3.H Helicon div=1 filt=splan$*_-0.1.H > pl3.H
	Add pl1.H pl2.H pl3.H | \
	${BINDIR}/Splinefilter.x post=y nw=-$* both=y | Window n2=75 > $@

${RESDIR}/sthree.v ${RESDIR}/sthree.v3: sthree2.H sthree4.H
	< sthree2.H ${SGREY} out=three2.v \
		title="Spline waves B-1 (linear)" titlesz=9
	< sthree4.H ${SGREY} out=three4.v \
		title="Spline waves B-3 (cubic)" titlesz=9
	vp_Movie three2.v three4.v > ${RESDIR}/sthree.v3
	vp_SideBySideAniso three2.v three4.v > ${RESDIR}/sthree.v

##################### 3-D real #############################################
vnmo.H: ${DATADIR}/vnmo.H
	< ${DATADIR}/vnmo.H ${TRANSP} | ${TRANSP} plane=23 > $@

head-win.H: ${DATADIR}/jupiter_win.H@@
	< ${DATADIR}/jupiter_win.H@@ Window n1=4 f1=11 > $@

offset-win.H: ${DATADIR}/jupiter_win.H@@
	< ${DATADIR}/jupiter_win.H@@ Window n1=1 f1=15 > $@

vel-win.H: vnmo.H ${BINDIR}/Velint.x head-win-transp.H
	< vnmo.H ${BINDIR}/Velint.x cmp=head-win-transp.H nw=4 > $@

nmo-win.H: ${DATADIR}/jupiter_win.H vel-win-transp.H \
	${BINDIR}/NMO3.x offset-win.H nmo.p
	< ${DATADIR}/jupiter_win.H ${BINDIR}/NMO3.x \
	offset=offset-win.H vel=vel-win-transp.H par=nmo.p > nmo-win.H
	echo hff=-1 >> $@
	echo gff=-1 >> $@

dat-win.H: nmo-win.H
	< nmo-win.H Window n1=250 f1=100 > $@

%-win-transp.H: %-win.H
	< $*-win.H ${TRANSP} > $@

smo2-win.H: dat-win-transp.H head-win-transp.H \
	grid.p ${BINDIR}/Invinter2.x gtens0.H
	< dat-win-transp.H ${BINDIR}/Invinter2.x coord=head-win-transp.H \
	filt=gtens0.H par=grid.p spline=n niter=50 > $@

%-dip.H: %.H ${BINDIR}/Smooth3.x
	< $*.H ${BINDIR}/Smooth3.x mask=$*.H nliter=10 > $@

%-pch.H: %-dip.H ${BINDIR}/Patch.x 
	< $*-dip.H ${BINDIR}/Patch.x pmax=4 np=400 > $@

bank%.H nh%.H lag%.H: ${BINDIR}/Splinebank.x
	${BINDIR}/Splinebank.x nw=$* pmax=4 np=400 nh=nh$*.H lag=lag$*.H \
	nt=100 niter=20 eps=0.0001 > bank$*.H

int2-win.H: dat-win-transp.H head-win-transp.H smo2-win-pch.H grid.p \
	${BINDIR}/Ninvinter2.x bank2.H nh2.H lag2.H 
	< dat-win-transp.H ${BINDIR}/Ninvinter2.x coord=head-win-transp.H \
	filt=bank2.H nh=nh2.H lag=lag2.H pch=smo2-win-pch.H \
	par=grid.p spline=n Xeps=1 niter=50 > $@


TITLE.bin = Binning
TITLE.int4 = B-spline+plane
TITLE.int2 = Linear+plane

${RESDIR}/int2-win.v: int2-win.H
	< int2-win.H ${TRANSP} plane=23 > junk.H
	< junk.H ${TRANSP} > transp.H
	< transp.H Byte gainpanel=all > int2.A
	< int2.A ${CUBE1} title=${TITLE.int2} out=$@

int4-win.H: dat-win-transp.H head-win-transp.H smo2-win-pch.H grid.p \
	${BINDIR}/Ninvinter2.x bank4.H nh4.H lag4.H ${BINDIR}/Splinefilter.x
	< dat-win-transp.H ${BINDIR}/Ninvinter2.x coord=head-win-transp.H \
	filt=bank4.H nh=nh4.H lag=lag4.H pch=smo2-win-pch.H \
	par=grid.p spline=y nw=4 eps=1 niter=50 | \
	${BINDIR}/Splinefilter.x nw=4 post=y both=y > $@

bin-win.H fold-win.H: grid.p dat-win-transp.H head-win-transp.H \
	${BINDIR}/Bin2.x
	${BINDIR}/Bin2.x par=grid.p hff=head-win-transp.H fold=fold-win.H \
	interp=1 <dat-win-transp.H > bin-win.H

${RESDIR}/fold-win.v: fold-win.H
	<fold-win.H Grey allpos=y pclip=100 \
	transp=n yreverse=n wantscalebar=1 \
	label1="In-line midpoint" label2="Cross-line midpoint" \
	wheretitle=t wherexlabel=b \
	title="Fold Map" out=$@ > /dev/null

${RESDIR}/%-win.v: %-win.H
	< $*-win.H ${TRANSP} plane=23 > junk.H
	< junk.H ${TRANSP} > transp.H
	< transp.H Byte gainpanel=all > $*.A
	< $*.A ${CUBE1} title=${TITLE.$*} out=$@

${RESDIR}/winslice.v: int4-win.H bin-win.H
	< bin-win.H Window n3=1 f3=132 | \
	Grey crowd1=0.8 title='t=0.928' >/dev/null \
	labelsz=18 titlesz=24 transp=n out=slice1.v
	< bin-win.H Window n3=1 f3=164 | \
	Grey crowd1=0.8 title='t=1.056' >/dev/null \
	labelsz=18 titlesz=24 transp=n out=slice3.v
	< bin-win.H Window n3=1 f3=196 | \
	Grey crowd1=0.8 title='t=1.184' >/dev/null \
	labelsz=18 titlesz=24 transp=n out=slice2.v
	< bin-win.H Window n3=1 f3=228 | \
	Grey crowd1=0.8 title='t=1.312' >/dev/null \
	labelsz=18 titlesz=24 transp=n out=slice4.v
	vp_OverUnderAniso slice1.v slice2.v slice3.v slice4.v > bin.v
	< int4-win.H Window n3=1 f3=132 | \
	Grey crowd1=0.8 title='t=0.928' >/dev/null \
	labelsz=18 titlesz=24 transp=n out=slice1.v
	< int4-win.H Window n3=1 f3=164 | \
	Grey crowd1=0.8 title='t=1.056' >/dev/null \
	labelsz=18 titlesz=24 transp=n out=slice3.v
	< int4-win.H Window n3=1 f3=196 | \
	Grey crowd1=0.8 title='t=1.184' >/dev/null \
	labelsz=18 titlesz=24 transp=n out=slice2.v
	< int4-win.H Window n3=1 f3=228 | \
	Grey crowd1=0.8 title='t=1.312' >/dev/null \
	labelsz=18 titlesz=24 transp=n out=slice4.v
	vp_OverUnderAniso slice1.v slice2.v slice3.v slice4.v > int4.v
	vp_SideBySideAniso bin.v int4.v > slice.v
	< slice.v vppen vpstyle=n xsize=12 ysize=8 > $@

##################### 3-D vs splitting ############################
lintens1.H: ${BINDIR}/Spline0.x
	${BINDIR}/Spline0.x eps=0.001 tension=1 > $@

tens1.v: lintens1.H 
	Spike n1=60 n2=60 nsp=1 k1=30 k2=30 > inp.H
	<inp.H Helicon       div=1 filt=lintens1.H > div.H
	<div.H Helicon adj=1 div=1 filt=lintens1.H > div2.H
	<div2.H ${GREY} out=$@ pclip=99 title=factorization allpos=y

bob.H: bob.HH
	< bob.HH Dd esize=4 | Window > $@

bob1.v: bob.H 
	Spike n1=60 n2=60 nsp=1 k1=30 k2=30 > inp.H
	<inp.H Helicon       div=1 filt=bob.H > div.H
	<div.H Helicon adj=1 div=1 filt=bob.H > div2.H
	<div2.H ${GREY} out=$@ pclip=99 title=splitting allpos=y

${RESDIR}/bob.v: tens1.v bob1.v
	vp_SideBySideAniso tens1.v bob1.v > ${RESDIR}/bob.v

############ Interpolation beyond aliasing #############################

aliasp.H: ${BINDIR}/Aliasp.x
	${BINDIR}/Aliasp.x cycles=25 > $@

%-pad2.H %-mask4.H: %.H ${BINDIR}/LPad.x
	<$*.H ${BINDIR}/LPad.x jump=4 mask=$*-mask4.H > $*-pad2.H

aliasp-pq2.H: ${BINDIR}/Smooth2.x aliasp.H
	< aliasp.H ${BINDIR}/Smooth2.x nw=3 nj=4 eps=0.04 > $@

aliasp-p2.H: aliasp.H aliasp-pq2.H ${BINDIR}/Smooth.x 
	< aliasp.H ${BINDIR}/Smooth.x nw=3 nj=4 pfile=aliasp-pq2.H | \
	Transp > $@

aliasp-q2.H: aliasp-p2.H ${BINDIR}/Double.x 
	< aliasp-p2.H ${BINDIR}/Double.x nw=4 | \
		      ${BINDIR}/Double.x nw=4 | Transp > $@

%-mis4.H: %-pad2.H %-mask4.H %-q2.H ${BINDIR}/Miss1.x 
	< $*-pad2.H ${BINDIR}/Miss1.x nw=3 \
	dip=$*-q2.H mask=$*-mask4.H niter=100 > $@

${RESDIR}/aliasp2.v: aliasp.H aliasp-mis4.H
	<aliasp.H Window n1=575 | Grey title=Input \
	crowd=0.9 >/dev/null wantaxis=n out=inp.v
	<aliasp-mis4.H Window n1=575 | Grey title=Output \
	crowd=0.9 >/dev/null wantaxis=n out=out.v
	vp_SideBySideAniso inp.v out.v > $@

################ offcon impulse response ###############################
taper.H: spike.p ${BINDIR}/Dipfilter.x taper.p
	Spike  par=spike.p | \
	${BINDIR}/Dipfilter.x par=taper.p | \
	Bandpass flo=10 fhi=50 > $@

${RESDIR}/off-imp.v ${RESDIR}/off-imp.v3: taper.H \
	${BINDIR}/Stretch.x ${BINDIR}/FFT.x ${BINDIR}/Fincon.x \
	${BINDIR}/Prod.x ${BINDIR}/Oper.x
	<taper.H ${BINDIR}/Stretch.x dens=2 | Rtoc | \
	${BINDIR}/FFT.x sign1=1 sign2=1 > fft.H
	<fft.H ${BINDIR}/Oper.x h=0.5 | ${BINDIR}/Prod.x prod=fft.H > out.H
	< out.H ${BINDIR}/FFT.x sign1=-1 sign2=-1 | Real | \
	${BINDIR}/Stretch.x inv=1 dens=2 >imp.H
	<imp.H ${OGREY} title="Omega-K IDMO impulse response" out=imp1.v
	<taper.H ${BINDIR}/Stretch.x dens=2 | Rtoc | \
	${BINDIR}/FFT.x sign1=1 > fft.H
	<fft.H ${TRANSP} | \
	${BINDIR}/Fincon.x h0=0 dh=0.004 nh=125 | \
	${TRANSP} >out.H
	<out.H ${BINDIR}/FFT.x sign1=-1 | Real | \
	${BINDIR}/Stretch.x inv=1 dens=2 >imp.H
	<imp.H ${OGREY} title="FinDif OC impulse response" out=imp2.v
	vp_SideBySideAniso imp1.v imp2.v > ${RESDIR}/off-imp.v
	vp_Movie imp1.v imp2.v > ${RESDIR}/off-imp.v3

clean : jclean
	${RM} ${BINDIR}/*.x
	${RM} ${OBJDIR}/*.o

include ${SEPINC}/SEP.bottom
