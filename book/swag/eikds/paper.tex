\input{macro}

\def\bea{\begin{eqnarray}}
\def\eea{  \end{eqnarray}}

\lefthead{Alkhalifah and Fomel}
\righthead{Source perturbation eikonal}
\published{Geophysics, 75, T175-T183 (2010)}
\title{An eikonal based formulation for traveltime  \\ perturbation with respect to the source location}

\email{tkhalfah@kacst.edu.sa, sergey@sep.stanford.edu}

\author{Tariq Alkhalifah and Sergey Fomel}

\maketitle

\begin{abstract}
  Traveltime calculations amount to solving the nonlinear eikonal
  equation for a given source location. We analyze the relationship
  between the eikonal solution and its perturbations with respect to
  the source location and develop a partial differential equation that
  relates the traveltime field for one source location to that for a
  nearby source.  This linear first-order equation in one form depends
  on lateral changes in velocity and in another form is independent of
  the velocity field and relies on second-order derivatives of the
  original traveltime field. For stable finite-difference
  calculations, this requires \geosout{that} the velocity field \geouline{to}
  be smooth in a sense similar to ray-tracing requirements. Our
  formulation for traveltime perturbation formulation has \geosout{three}
  \geouline{several} potential applications, \geouline{such that} \geosout{First, it
    can be used for} fast traveltime calculation by source-location
  perturbation, \geosout{Second, it can be used for} velocity-independent
  interpolation including datuming, \geouline{and} \geosout{as well as}
  velocity estimation. \geosout{Third,} \geouline{Additionally,} higher-order
  expansions provide parameters necessary for Gaussian-beam
  computations.
\end{abstract}


\section{Introduction}

The traveltime field is typically used to describe the phase behavior
of the Green's function, a key tool for Kirchhoff modeling and
migration. It also is used at the heart of many velocity estimation
applications, such as \geouline{reflection} tomography. The traveltime
field for a fixed source in a heterogeneous medium is governed by the
eikonal equation, derived about 150 years ago by Sir William Rowan
Hamilton. Since early 1990s, a direct numerical solution of the
eikonal equation has been a popular method of computing traveltimes on
regular grids, commonly used in seismic imaging
\cite[]{vidale,GEO55-05-05210526,GEO56-06-08120821,podvin.gji.91}. Modern
methods of traveltime computation include the {\it{fast marching}}
method, developed by \cite{paper2} in the general context of level set
methods for propagating interfaces. \cite{GEO64-02-05160523} and
\cite{GEO67-02-06040609} report a successful application of this
method in three-dimensional seismic computations.
\cite{GPR49-02-01650178} improved its accuracy using spherical
coordinates. Alternative methods \geosout{are} \geouline{include} group fast
marching \cite[]{GEO67-04-12251231}, fast sweeping \cite[]{zhao}, and
\geouline{paraxial marching} \cite[]{GEO67-01-01670176}. \geosout{etc.} Several
alternative schemes are reviewed by \cite{GEO67-04-12251231}. 


% S. Fomel, S. Luo, and H. Zhao, 2009, Fast sweeping method for the factored eikonal equation: Journal of Computational Physics, v. 228, 6440-6455. 

The nonlinear nature of the eikonal partial differential equation was
addressed by \cite{GEO59-10-16311632}, who linearized the eikonal
equation with respect to velocity perturbation, while retaining its
first-order nature. \cite{GPR50-04-03730382} developed a similar
linearization formula for perturbations in anisotropic parameters and
solved it numerically using the fast marching method.  The linear
feature increased the efficiency and stability of the numerical
solution, especially in the anisotropic case.

A major drawback of using conventional methods to solve the eikonal
equation numerically\geosout{,} is that we only evaluate the fastest arrival
solution, not necessarily the most energetic one.  This results in
less than acceptable traveltime computation for imaging in complex
media \cite[]{GEO58-04-05640575}.  Eikonal solvers can be extended to
image multiple arrivals through semi-recursive Kirchhoff migration
\cite[]{GEO62-02-05770588}, phase-space equations \cite[]{pnas}, or
slowness matching \cite[]{slowness} techniques. The linearization also
helps to avoid \geosout{this} \geouline{the first-arrival only} limitation, especially when the background
traveltime field includes energetic arrivals.


The dependence of the traveltime field \geosout{shape} on the source location
can be empirically evaluated by comparing the shape of the traveltime
fields for two different sources when the sources are \geosout{overlapped} \geouline{superimposed on each other}. For
a medium with no lateral velocity variation, the traveltime field
\geosout{shape} should be source\geouline{-}location independent. Relating the two
traveltime fields directly through an equation can provide insights
into the dependence of traveltime fields on lateral velocity
variation\geouline{s}. Such information can serve in developing better
traveltime interpolation and velocity estimation. 

In this paper, we develop a new eikonal-based partial differential
equation that relates traveltime shape changes to changes in the
source location.  The changes can be described \geosout{in terms of}
first- or second-order \geosout{accuracy} \geouline{accurate terms} and thus
used in a Taylor's type expansion to find the traveltime for a nearby
source.  We test the accuracy of the approximation analytically and
numerically through \geouline{the use of} \geosout{using} complex
\geouline{synthetic} models. In the discussion section, we suggest possible
applications for \geosout{such a formula} \geouline{the new equation}.

\section{Shift in the source location}

\inputdir{XFig}

% N. Bleistein, Mathematical Methods for Wave Phenomena, Academic
% Press, New York, 1984.

The eikonal equation appears in the zeroth-order asymptotic expansion
of the solution of the wave equation given by the Wentzel, Kramers,
and Brillouin (WKB) approximation. It represents
the geometrical optics term that contains the most rapidly varying
component of the leading behavior of the expansion. In a medium with
sloth (slowness squared), $w$, the traveltime $\tau$ for a wavefield
emanating from a source satisfies the following formula:
\begin{equation}
\left(\frac{\partial \tau}{\partial x}\right)^2 + 
\left(\frac{\partial \tau}{\partial y}\right)^2+
\left(\frac{\partial \tau}{\partial z}\right)^2 =w(x,y,z),
\label{eq:eikonalis}
\end{equation}
where $(x,y,z)$ are the components of the 3-D medium. At the location
of the source $(x_s,y_s,z_s)$, the initial value of time
$\tau(x_s,y_s,z_s)=0$ is needed for numerically solving the eikonal
equation~\ref{eq:eikonalis}.  Moving the source along the $x$-axis a
distance $l$ is equivalent to solving the following eikonal equation:
\begin{equation}
\left(\frac{\partial \tau}{\partial x}\right)^2 + 
\left(\frac{\partial \tau}{\partial y}\right)^2+
\left(\frac{\partial \tau}{\partial z}\right)^2 =w(x-l,y,z),
\label{eq:eikonalds}
\end{equation}
for the same source location. In other words, we are replacing a shift in the source location with an equal distance shift in the velocity field
in the opposite direction.
Figure~\ref{fig:timeds} shows the operation for a single source and image point combination 
\geouline{taking into account the reciprocity principle between sources and receivers}.

\sideplot{timeds}{width=\textwidth}{Illustration of the relation between the
  initial source location and a perturbed version given by a single
  source and image point locations. This is equivalent to a shift in
  the velocity field laterally by $dl$.}

Assuming that the sloth (or velocity) field is continuous in the $x$
direction, we differentiate equation~\ref{eq:eikonalds} with respect
to $l$ and get:
\begin{equation}
2 \frac{\partial \tau}{\partial x} \, \frac{\partial^2 \tau}{\partial x \partial l} + 
2 \frac{\partial \tau}{\partial y} \, \frac{\partial^2 \tau}{\partial y \partial l}+
2 \frac{\partial \tau}{\partial z} \, \frac{\partial^2 \tau}{\partial z \partial l} = -\frac{\partial w}{\partial x}.
\label{eq:eikds1}
\end{equation}
Substituting the change in traveltime field shape due to source
perturbation, $D_x=\frac{\partial \tau}{\partial l}$, into
equation~\ref{eq:eikds1} provides a first order linear equation in
$D_x$ given by:
\begin{equation}
2 \frac{\partial \tau}{\partial x} \, \frac{\partial D_x}{\partial x}+ 
2 \frac{\partial \tau}{\partial y} \, \frac{\partial D_x}{\partial y} +
2 \frac{\partial \tau}{\partial z} \, \frac{\partial D_x}{\partial z} = - \frac{\partial w}{\partial x}.
\label{eq:eikdsD}
\end{equation}
Solving for $D_x$ requires the velocity (sloth) field as well as the traveltime field $\tau$ for a source located at the surface at $l_0$. Thus,the 
traveltime field for a source at $l$ can be approximated by
\begin{equation}
t(x,y,z) \approx \tau(x,y,z) + D_x(x,y,z) (l-l_0).
\label{eq:eiktim}
\end{equation}


Equation~\ref{eq:eikdsD} is velocity  dependent\geouline{,} which limits \geosout{it's} \geouline{its} use for inversion purposes. 
However, a differentiation of Equation~\ref{eq:eikonalds} with respect to $x$ produces
\begin{equation}
2 \frac{\partial \tau}{\partial x} \, \frac{\partial^2 \tau}{\partial x^2}+ 
2 \frac{\partial \tau}{\partial y} \, \frac{\partial^2 \tau}{\partial x \partial y} +
2 \frac{\partial \tau}{\partial z} \, \frac{\partial^2 \tau}{\partial x \partial z} = \frac{\partial w}{\partial x}.
\label{eq:eikds2}
\end{equation}
Adding equations~\ref{eq:eikds1} and~\ref{eq:eikds2} yields \geouline{equation}
\begin{equation}
\frac{\partial \tau}{\partial x} \, \frac{\partial^2 \tau}{\partial x \partial l} + 
\frac{\partial \tau}{\partial y} \, \frac{\partial^2 \tau}{\partial y \partial l}+
\frac{\partial \tau}{\partial z} \, \frac{\partial^2 \tau}{\partial z \partial l} = \frac{\partial \tau}{\partial x} \, \frac{\partial^2 \tau}{\partial x^2}+ 
\frac{\partial \tau}{\partial y} \, \frac{\partial^2 \tau}{\partial x \partial y}+
\frac{\partial \tau}{\partial z} \, \frac{\partial^2 \tau}{\partial x \partial z},
\label{eq:eikds}
\end{equation}
which is velocity independent. Substituting again the change in
traveltime with source location $D_x=\frac{\partial \tau}{\partial l}$
into equation~\ref{eq:eikds} yields
\begin{equation}
\frac{\partial \tau}{\partial x} \, \frac{\partial D_x}{\partial x} + 
\frac{\partial \tau}{\partial y} \, \frac{\partial D_x}{\partial y}+
\frac{\partial \tau}{\partial z} \, \frac{\partial D_x}{\partial z} = \frac{\partial \tau}{\partial x} \, \frac{\partial^2 \tau}{\partial x^2}+ 
\frac{\partial \tau}{\partial y} \, \frac{\partial^2 \tau}{\partial x \partial y}+
\frac{\partial \tau}{\partial z} \, \frac{\partial^2 \tau}{\partial x \partial z},
\label{eq:eikdsF}
\end{equation}
which is a first order linear partial differential equation in $D_x$
with $D_x$=0 at the source. The traveltime derivatives are computed
for a given traveltime field $\tau$ corresponding to a source location
$l_0$.  Equation~\ref{eq:eikdsF} can be represented in a vector
notation as follows:
\begin{equation}
\nabla \tau \cdot \nabla D_x \, = \, \nabla \tau \cdot \nabla \frac{\partial \tau}{\partial x}.
\label{eq:eikdsFF}
\end{equation}

A similar treatment for a change of the source location in $y$ or $z$ yields the following equations, respectively:
\begin{equation}
\frac{\partial \tau}{\partial x} \, \frac{\partial D_y}{\partial x} + 
\frac{\partial \tau}{\partial y} \, \frac{\partial D_y}{\partial y}+
\frac{\partial \tau}{\partial z} \, \frac{\partial D_y}{\partial z} = \frac{\partial \tau}{\partial x} \, \frac{\partial^2 \tau}{ \partial x \partial y}+ 
\frac{\partial \tau}{\partial y} \, \frac{\partial^2 \tau}{\partial y^2}+
\frac{\partial \tau}{\partial z} \, \frac{\partial^2 \tau}{\partial y \partial z},
\label{eq:eikdsyF}
\end{equation}
or
\begin{equation}
\nabla \tau \cdot \nabla D_y \, = \, \nabla \tau \cdot \nabla \frac{\partial \tau}{\partial y}.
\label{eq:eikdsFFy}
\end{equation}
and
\begin{equation}
\frac{\partial \tau}{\partial x} \, \frac{\partial D_z}{\partial x} + 
\frac{\partial \tau}{\partial y} \, \frac{\partial D_z}{\partial y}+
\frac{\partial \tau}{\partial z} \, \frac{\partial D_z}{\partial z} = \frac{\partial \tau}{\partial x} \, \frac{\partial^2 \tau}{\partial x \partial z}+ 
\frac{\partial \tau}{\partial y} \, \frac{\partial^2 \tau}{\partial y \partial z}+
\frac{\partial \tau}{\partial z} \, \frac{\partial^2 \tau}{\partial z^2},
\label{eq:eikdszF}
\end{equation}
or
\begin{equation}
\nabla \tau \cdot \nabla D_z \, = \, \nabla \tau \cdot \nabla \frac{\partial \tau}{\partial z}.
\label{eq:eikdsFFz}
\end{equation}
The above set of equations provides a tool for calculating first-order
traveltime derivatives with respect to the source location.  However,
a condition for stability is that the velocity field must be
continuous. This condition is analogous to conditions used in ray
tracing methods and can be enforced using smoothing
techniques. Another approach to handle this limitation is discussed
later.

\section{A linear velocity model example}

As a first test to \geosout{these} \geouline{our} formulations, we consider a
2-D model where the velocity changes linearly in the direction of the
source perturbation. In this case, the traveltime is described
analytically as a function of $x$ and $z$ and so will the traveltime
changes, $D_x$. Restricting this example to models with change of
velocity in the direction of the source perturbation does not limit
its generality since changes in the orthogonal direction has no direct
influence on \geouline{the} traveltime field. \geosout{shape.}

In the first example, we consider a source perturbation in the
vertical direction in a medium in which the velocity changes linearly
in the vertical direction. Considering source perturbation in the
vertical direction is useful for applications related to datuming and
possibly downward continuation. The linear velocity model is defined
by
\begin{equation}
v(z) = v_0 + a z.
\label{eq:vz}
\end{equation}
where $a$ is the vertical velocity gradient and $v_0$ is velocity at
the surface $z=0$.  The traveltime from a source at $x=z=0$ to a point
in the subsurface given by $x$ and $z$ is provided by
\cite{LSC00-00-02680268}, as follows:
\begin{equation}
\tau(x,z) = \frac{1}{a} \cosh^{-1}\left(\frac{a^2 z^2 \left(\frac{x^2}{z^2}+1\right)}{2 v_0 \left(a z+v_0\right)}+1\right).
\label{eq:vlinz}
\end{equation}
Evaluating $\frac{\partial \tau}{\partial x}$ and $\frac{\partial
  \tau}{\partial y}$ and using \geosout{that to solve} equation~\ref{eq:eikdsD}
yields:
\begin{equation}
D_z =- \frac{\left(a z+2 v_0\right) \sqrt{\frac{a^2 \left(x^2+z^2\right)}{a^2 x^2+\left(a z+2 v_0\right){}^2}}}{v_0 \left(a
   z+v_0\right)},
\label{eq:vlinzD}
\end{equation}
which is an analytical representation of the change in the traveltime
field shape with source depth location for this specific linear model
and can be used to predict the traveltime for a source at a different
depth.  To test equation~\ref{eq:vlinzD}, we use
equation~\ref{eq:vlinz} to estimate the traveltime using
expansion~\ref{eq:eiktim} and compare that with the true traveltime
for that source. Figure~\ref{fig:diff2} shows this difference for a
model with (a) a vertical velocity gradient of
\geouline{0.5~$\mbox{s}^{-1}$} and (b) a vertical velocity gradient of
\geouline{0.7~$\mbox{s}^{-1}$}. A 200 meter vertical shift, used here for
the source, is typical of corrections applied in datuming among other
applications.  The errors, as expected, increase with an increase in
velocity gradient as zero velocity gradient results in no change in
traveltime shape and thus no errors. However, the errors are generally
small for both gradients with the maximum value of 0.007 s occurring
for the largest offset to depth ratio.  \inputdir{Math}

\plot{diff2}{width=\textwidth}{A color contour plot of the traveltime errors
  using the perturbation equation as a function of location ($x,z$)
  for a linear velocity model of with $v_0$=2000 m/s and a vertical
  velocity gradient of 0.5$s^{-1}$ for (a) and 0.7$s^{-1}$ for (b). In
  both cases, the vertical source perturbation distance is 200
  meters. The maximum traveltime errors are (a) 0.004 s and (b) 0.007
  s.}


In the second example, we consider source perturbation laterally in a
medium in which the velocity changes linearly in the lateral
direction. Considering source perturbation in the lateral direction
could be useful for velocity estimation, beam based imaging, and
interpolation applications, and more inline with the objectives of
this study.  In this case, the linear velocity model is defined by
\begin{equation}
v(x) = v_0 + a x.
\label{eq:vx}
\end{equation}
where $a$ is now the lateral velocity gradient and $v_0$ is velocity
at the vertical line $x=0$.  The traveltime and $D_x$ are given by
formulations similar to equations~\ref{eq:vlinz} and~\ref{eq:vlinzD},
but with an orthogonal transformation of coordinates. Though the
equations are similar, we want to get an estimate of the error
distribution for this problem. Figure~\ref{fig:diffx2} shows the
traveltime errors for using these new formula to predict the changes
due to shifts in the source location by (a) 100 meters and (b) 200
meters. As expected, the errors increase with the amount of
shift. However, in both cases the errors are generally small and
bounded by 0.002 s.

\plot{diffx2}{width=\textwidth}{A color contour plot of the traveltime errors
  using the perturbation equation as a function of location ($x,z$)
  for a linear velocity model of with $v_0$=2000 m/s and a horizontal
  velocity gradient of 0.5$s^{-1}$ for (a) a horizontal source
  perturbation of 100 meters and (b) a horizontal source perturbation
  distance of 200 meters. The maximum traveltime errors are (a) 0.0005
  s and (b) 0.002 s.}


\section{Higher-order accuracy}

The accuracy of the above formulations are first order in source
perturbation, which is valid for small perturbation distances.  To
obtain a higher-order accuracy, we differentiate
equation~\ref{eq:eikds1} again with respect to $l$ yielding:
\begin{equation}
2 \left(\frac{\partial^2 \tau}{\partial x \partial l}\right)^2 \, + 
2 \frac{\partial \tau}{\partial x} \, \frac{\partial^3 \tau}{\partial x \partial l^2} + 
2 \left(\frac{\partial^2 \tau}{\partial y \partial l}\right)^2 \, +
2 \frac{\partial \tau}{\partial y} \, \frac{\partial^3 \tau}{\partial y \partial l^2}+
2 \left(\frac{\partial^2 \tau}{\partial z \partial l}\right)^2 \, +
2 \frac{\partial \tau}{\partial z} \, \frac{\partial^3 \tau}{\partial z \partial l^2} = \frac{\partial^2 w}{\partial x^2}.
\label{eq:eikdsd2}
\end{equation}

Substituting the second derivative of traveltime with respect to
source location $D_{xx}=\frac{\partial^2 \tau}{\partial l^2}$ into
equation~\ref{eq:eikdsd2} provides us with a first order linear
partial differential equation in $D_{xx}$ given by:
\begin{equation}
2 \left(\frac{\partial D_x}{\partial x}\right)^2 \, + 
2 \frac{\partial \tau}{\partial x} \, \frac{\partial D_{xx}}{\partial x} + 
2 \left(\frac{\partial D_x}{\partial y}\right)^2 \, +
2 \frac{\partial \tau}{\partial y} \, \frac{\partial D_{xx}}{\partial y}+
2 \left(\frac{\partial D_x}{\partial z}\right)^2 \, +
2 \frac{\partial \tau}{\partial z} \, \frac{\partial D_{xx}}{\partial z} = \frac{\partial^2 w}{\partial x^2},
\label{eq:eikdsdd2}
\end{equation}
or
\begin{equation}
\nabla D_x \cdot \nabla D_x \, + \,\nabla \tau \cdot \nabla D_{xx} \, = \, \frac{1}{2} \frac{\partial^2 w}{\partial x^2}
\label{eq:eikdssM}
\end{equation}
This equation is similar in form to the first order equations, but
with a different source function. Of course, $D_x$ must be evaluated
first using equation~\ref{eq:eikdsD} to solve
equation~\ref{eq:eikdssM}.

Based on Taylor's series expansion, the traveltime for a source at $l$ is approximated by
\begin{equation}
t(x,y,z) \approx \tau(x,y,z) + D_x(x,y,z) (l-l_0)+ \frac{1}{2} D_{xx}(x,y,z) (l-l_0)^2.
\label{eq:expansion}
\end{equation}

Using an infinite series representation by defining poles to eliminate
the most pronounced transient behavior using Shanks transforms \cite[]{Bender}, we can
represent the second order Taylor's expansion in
equation~\ref{eq:expansion} as follows
\begin{equation}
t(x,y,z) \approx \tau(x,y,z) + \frac{{D_x}^2(x,y,z) (l-l_0)}{D_x(x,y,z) (l-l_0)+ \frac{1}{2} D_{xx}(x,y,z) (l-l_0)^2},
\label{eq:expansion2}
\end{equation}
which can provide a better approximation results in some regions but has an obvious singularity that might cause divergence when the denominator tends to zero.

% Bender, C.M.; Orszag, S.A. (1999), Advanced mathematical methods for
% scientists and engineers: Asymptotic Methods and Perturbation
% Theory, Springer.

Similar equations for expansions in 3-D are obtained with the help of the following matrix
\begin{equation}
\left(
\begin{array}{ccc}
D_{xx}  & D_{xy} & D_{xz} \\
D_{xy} & D_{yy} & D_{yz} \\
D_{xz} & D_{yz} & D_{zz}
\end{array}
\right) = 
\left(
\begin{array}{ccc}
\frac{\partial^2 \tau}{\partial l_x^2}
  & \frac{\partial^2 \tau}{\partial l_x l_y} & \frac{\partial^2 \tau}{\partial l_x l_z} \\
\frac{\partial^2 \tau}{\partial l_x l_y} & \frac{\partial^2 \tau}{\partial l_y^2} & \frac{\partial^2 \tau}{\partial l_y l_z} \\
\frac{\partial^2 \tau}{\partial l_x l_z} & \frac{\partial^2 \tau}{\partial l_y l_z} & \frac{\partial^2 \tau}{\partial l_z^2}
\end{array}
\right),
\label{eq:MM}
\end{equation}
with components obtainable using similar first order partial
differential equations shown in Appendix A, where $l_x$, $l_y$, and
$l_z$ describe source perturbations in the $x$, $y$, and $z$
directions, respectively. These equations can form the basis for beam
expansions in beam-type migrations.


The higher-order equations provide better approximations of the
traveltime perturbation.  However, they require both the velocity and
its derivative to be continuous in the direction of the source
perturbation.

\section{Algorithm}

All the traveltime source perturbation equations developed above are
linear first order partial differential equations that can be solved
using any of the many upwind numerical methods. \geosout{Like}
\geouline{Similar to} \cite{franklin} and \cite{GPR50-04-03730382}, we will
rely on the fast marching method \cite{paper2} to solve such linear equations.

% Franklin, J.B.  and Harris, J.M., "A High-Order Fast Marching Scheme
% For The Linearized Eikonal Equation", Journal of Computational
% Acoustics, Vol.9,No.3, pp.1095-1109, 2001.

An update procedure for such a method is based on an upwind first or
second-order approximation to the new equations. In simple terms, the
procedure starts with selecting one or more (up to three) neighboring
points around the updated point. The traveltime values at the selected
neighboring points need to be smaller than the current value. After
the selection, one solves the discrete version of the linear partial
differential equation for $D_x$.  We add this perturbation value
multiplied by the perturbation distance to the background traveltime.
As the result of the updating, either a \emph{FarAway} point is marked
as \emph{NarrowBand} or a \emph{NarrowBand} point gets assigned a new
value. This process is repeated until we run out of points in the
narrow band.

In all cases, we will need the traveltime field for a given source obtained using the eikonal equation or ray-based methods. This
traveltime field serves as the background field for predicting the traveltime for other sources.
For the first-order accuracy expansion, we have to only solve the linear source differential eikonal partial differential equation once.
However, for the second order expansion or its shank transform representation, we will need $D_{xx}$, and thus need to solve an
equivalent linear differential equation again. 

The critical part of solving these equations is the need to evaluate
the first and second order derivatives of the velocity field or
equivalently the \geosout{2nd} \geouline{second-} and \geosout{3rd}
\geouline{third-}order derivatives of the background traveltime field all
with respect to the direction in which the source is perturbed. This
poses a challenge in media where the velocity changes abruptly in that
direction.  Therefore, some smoothing may be required for the velocity
field in the source perturbation direction.

\section{Examples}

\subsection{Lens example}

\inputdir{smvel}

Since the differential equation depends on velocity changes in the
direction of the source shift, we test the methodology on a model that
contains a lens anomaly in an otherwise constant velocity gradient
($\frac{dv}{dx}=0.5 s^{-1}$ and $\frac{dv}{dz}=0.7 s^{-1}$ with
velocity at the origin equal to 2 km/s) model.  The lens is located at
600 meters laterally and 500 meters depth with a velocity perturbation
of +500 m/s (or 20\%). The lens has a diameter of 200 meters and
causes a large velocity variation. Using this model, we test the
accuracy of the first-order, second-order, and the Shanks-transform
representation equations.

For a source located at 200 meters lateral distance from origin and
200 meter depth, we solve the eikonal equation using the fast marching
method with second order accuracy. The \geosout{travel} \geouline{traveltime} field in this case is
represented by the \geosout{semi-solid} \geouline{solid} contours on the left side plots of
Figures~\ref{fig:circ1}, \ref{fig:circ2}, and~ \ref{fig:circ3}. We
also solve the eikonal equation for source located virtually 100
meters away in lateral direction and it is represented by the \geosout{semi-solid} \geouline{solid} curves in the
middle plot of the three Figures. Solving for $D_x$ using
equation~\ref{eq:eikds1} and using that along with the original
traveltime field, we obtain an approximate traveltime field for a
source 100 meters away. This new traveltime field is represented by
the dashed contour curves in Figure~\ref{fig:circ1}. The absolute
difference between the simulated traveltime and the true one both
displayed in the center plot is given by the density plot shown on the
right side of Figure~\ref{fig:circ1}.

\plot{circ1}{width=6in}{The traveltime contour (solid curve) plot
  for a source at lateral and depth position of 0.2 km (left) and for a source virtually
  perturbed by 100 meters in the lateral direction (middle), both compared with the traveltime
  derived using the first-order accuracy perturbation eikonal for a
  100 meters virtual shift (dashed curves). In both plots the velocity field is shown in the
background. Also shown on the right is a density plot of the difference between the two contours in the middle plot.}

The errors are generally small (less than 0.008 s), with the largest
of errors appearing on the lower side of the lens. This error is
generally small considering the large shift (100 meters) and
first-order nature of the expansion. In addition, errors for the rest
of the traveltime field corresponding to the linear variation in
velocity is extremely small.

\plot{circ2}{width=6in}{The traveltime contour (solid curve) plot
  for the original source (left) and for a source virtually
  perturbed by 100 meters in the lateral (middle), both compared with the traveltime
  derived using the second-order accuracy perturbation eikonal for a
  100 meters virtual shift (dashed curves). In both plots the velocity field is shown in the
background. Also shown on the right is a density plot of the difference between the two contours in the middle plot.}

Figure~\ref{fig:circ2} is similar to Figure~\ref{fig:circ1}, but now
we use the second-order expansion, which requires solving the linear
partial differential equation twice. Overall, as expected, the errors
are less than the first order case with clear reduction in the upper
side trail of the lens.

\plot{circ3}{width=6in}{The traveltime contour (solid curve) plot
  for the original source (left) and for a source virtually
  perturbed by 100 meters (middle), both compared with the traveltime
  derived using Shanks transform perturbation eikonal for a 100 meters
  virtual shift (dashed curves).  In both plots the velocity field is shown in
  the background. Also shown on the right is a density plot of the
  difference between the two contours in the middle plot.}

With hardly any additional computational cost, we can use the Shank
transform representation of the expansion and in this case the errors,
as shown in Figure~\ref{fig:circ3}, are reduced even further.

\plot{circ4}{width=6in}{A density plot of the traveltime error in percent for the difference plots in Figures~\protect\ref{fig:circ1}-\protect\ref{fig:circ3}
(right), plotted from left to right, respectively. The percent error is measured in a relative manner where 0 corresponds to the accurate traveltime and
100\% to the unperturbed traveltime.}
\geouline{To emphasize the role of the perturbation terms in approximating the source-shifted traveltime, we define a relative percent error as}
\begin{equation}
t_{err} = 100 \frac{\tau - \tau_0}{\tau_1 - \tau_0},
\label{eq:terr}
\end{equation}
\geouline{where $\tau_0$ is the unperturbed traveltime for the original source, $\tau_1$ is the traveltime for the desired source calculated directly using the 
conventional eikonal equation, and $\tau$ is the traveltime estimated using the perturbation equations for the desired source. If $\tau$ is equal to $\tau_1$, as
desired, the error is zero. However, if $\tau$ equals the unperturbed traveltime $\tau_0$ the error is 100 percent. Figure~\ref{fig:circ4} shows
this relative errors for the first-order accuracy perturbation (left), the second-order accuracy perturbation (middle), and 
using Shanks transform perturbation (right) for the linear model with a lens. The errors are overall less for the Shanks transform perturbation. The
large error at position and depth equal to 0.2 km corresponds to the source location, where the denominator of equation~\ref{eq:terr} tends to zero.}

\subsection{Marmousi example}

Despite \geouline{the fact} that the source perturbation differential equations are
dependent on the derivative of velocity, and thus, discontinuous
velocity fields pose a problem, we test the method on the unsmoothed
Marmousi model \cite[]{TLE13-09-09270936} to asses the stability of
the numerical process. In this case, we use only the first order
expansion to avoid relying on higher order derivatives of the velocity
field, which might breakdown here.

Figure~\ref{fig:cir1} shows the Marmousi model in the background with
the traveltime field contours computed directly using the finite
difference eikonal equation for a source located at 4.2 km at the
surface (dashed curves) compared with the traveltime field perturbed
from a source located 200 meters away at 4 km surface location. The
two contour curves overlap near the source, but show some difference
away from the source.  However, the difference is generally small
considering the large source perturbation of 200 meters and the
velocity complex model. 

\inputdir{marm2}

\plot{cir1}{width=6.0in}{The traveltime contour plot for a source at the
  surface at 4.2 km (dashed curves) and for a source virtually
  perturbed by 200 meters from the traveltime field at 4 km source
  surface location (solid curves). The perturbed traveltime is derived
  using the first-order accuracy perturbation eikonal.  The Marmousi
  velocity field is shown in the background.}

A closer and more quantitative look is given by the difference plot;
Figure~\ref{fig:cir2} shows a density plot for the difference in
traveltime contours in Figure~\ref{fig:cir1}. With a clip of 0.01
seconds, errors given in gray are small and dominate the plot. This is
a testament to the stability of the Fast marching implementation
despite the complex velocity field that includes many lateral
discontinuities.

\plot{cir2}{width=6.0in}{A density plot for the difference between the
  two contours shown in Figure~\protect{\ref{fig:cir1}}.}

\section{Discussion}

Seismic data are usually acquired with geophone layouts that record
information from multiple source locations. The redundancy in the
coverage is necessary to eliminate gaps in the data, estimate
velocity, and image the data. Thus, the direct relation between the
traveltime field and the source location allows us to estimate
attributes that can help in interpolation, velocity estimation and
possibly imaging. Specifically:
 \begin{itemize}
   \item \geouline{Traveltime compression schemes \cite[]{tariqc} require the ability to interpolate subsampled traveltimes.}

% The Many Benefits of Traveltime Compression for 3D Prestack Kirchhoff Migration: T. A. Alkhalifah,EAGE, Expanded Abstracts,,G047,(2006)

 \item One of the main sources of trace interpolation information is
   the behavior of wavefronts with respect to the source location.
 \item Velocity estimation relies directly on the change in traces as
   a function of source and receiver locations.

   \item \geouline{Kirchhoff antialiasing schemes
     \cite[]{SEG-1994-1282,GEO64-06-17831792} explicitly require the
     derivatives of the traveltime with respect to the source and
     receiver locations on the surface.}

 \item Gaussian-beam migration
   \cite[]{GEO55-11-14161428,GEO66-04-12401250,GEO60-05-14741484,GEO70-04-S71S77}
   relies on traveltime derivative information as a function of ray
   angle variations and source variations, which is usually obtained
   from the slower and less stable dynamic ray tracing.
 \item Efficient traveltime calculation can be achieved using first
   order linear equations instead of the nonlinear form of the eikonal
   equation.

 \end{itemize}

 However, the formulation developed here has limitations. Chief among
 them is the need to evaluate derivatives of velocity and traveltime
 fields.  Since velocities may include discontinuities, their
 derivatives are not easy to evaluate. However, similar to the
 ray-based methods, one can \geouline{simply} smooth the velocity field.

 Since traveltime fields that contain all arrivals satisfy the eikonal
 equation, the source perturbation can be applied to traveltimes
 extracted from other methods, such as ray tracing or escape
 equations. Therefore, they can include most energetic arrivals as
 opposed to first-arrival traveltimes.


\section{Conclusions}

The behavior of the traveltime field shape as a function of source
location in an inhomogeneous medium provides a platform for many
useful applications. We present eikonal-based equations that relate
traveltime field changes with respect to the source perturbations.
These equations are linear first-order differential equations that
depend on the background traveltime and velocity fields.  Their
solutions describe the first- and second-order changes in the
traveltime field as a function of the source location. These equations
are equivalent to the plane wave expansion extracted from dynamic ray
tracing, such as the one used for Gaussian-beam migration.  They can
be solved efficiently by finite-difference solvers on a regular grid.
The solutions are used to estimate the traveltime shape for
neighboring sources.  The accuracy of the equations depends on the
\geouline{complexity of} lateral velocity variation\geouline{s} \geosout{complexity}
as well as on the source perturbation distance.

\section{Acknowledgments}
The first author thanks KACST and KAUST for their
support of this research. We thank the editors and the 
reviewers of Geophysics for their critical review of the paper and the resulting improvements.

\bibliographystyle{seg}
\bibliography{SEP2,SEG,paper}

\appendix
\section{Appendix A: Higher-order expansions}

Traveltime \geosout{shape} behavior due to source perturbations can be
\geosout{better} estimated \geouline{more accurately} using higher-order
formulations. Considering that $l_x$, $l_y$, and $l_z$ represent
source perturbations in the $x$, $y$, and $z$ directions,
respectively, a full representation of the second derivative behavior
is given by the following symmetric matrix
\begin{equation}
\left(
\begin{array}{ccc}
D_{xx}  & D_{xy} & D_{xz} \\
D_{xy} & D_{yy} & D_{yz} \\
D_{xz} & D_{yz} & D_{zz}
\end{array}
\right) = 
\left(
\begin{array}{ccc}
\frac{\partial^2 \tau}{\partial l_x^2}
  & \frac{\partial^2 \tau}{\partial l_x l_y} & \frac{\partial^2 \tau}{\partial l_x l_z} \\
\frac{\partial^2 \tau}{\partial l_x l_y} & \frac{\partial^2 \tau}{\partial l_y^2} & \frac{\partial^2 \tau}{\partial l_y l_z} \\
\frac{\partial^2 \tau}{\partial l_x l_z} & \frac{\partial^2 \tau}{\partial l_y l_z} & \frac{\partial^2 \tau}{\partial l_z^2}
\end{array}
\right).
\label{eq:MM2}
\end{equation}
$D_{xx}$ is evaluated using the first order linear differential
equation~\ref{eq:eikdssM}, where $\tau$ is obtained from solving the
eikonal equation and $D_x$ is evaluated from equation~\ref{eq:eikdsD}.

Similarly, higher order approximations in $l_y$ and $l_z$ are given by
\begin{equation}
\nabla D_y \cdot \nabla D_y \, + \,\nabla \tau \cdot \nabla D_{yy} \, = \, \frac{1}{2} \frac{\partial^2 w}{\partial y^2}
\label{eq:eikdy}
\end{equation}
and
\begin{equation}
\nabla D_z \cdot \nabla D_z \, + \,\nabla \tau \cdot \nabla D_{zz} \, = \, \frac{1}{2} \frac{\partial^2 w}{\partial z^2},
\label{eq:eikdz}
\end{equation}
respectively, which represent the diagonal terms of the matrix in
equation~\ref{eq:MM2}.

To obtain the non-diagonal components of the matrix we differentiate
equation~\ref{eq:eikds1} with respect to $l_y$, instead of $l_x$,
yielding: \bea 2 \left(\frac{\partial^2 \tau}{\partial x \partial
    l_x}\right) \left(\frac{\partial^2 \tau}{\partial x \partial
    l_y}\right) \, + 2 \frac{\partial \tau}{\partial x} \,
\frac{\partial^3 \tau}{\partial x \partial l_x \partial l_y} + 2
\left(\frac{\partial^2 \tau}{\partial y \partial l_x}\right)
\left(\frac{\partial^2 \tau}{\partial y \partial l_y}\right) \, +
2 \frac{\partial \tau}{\partial y} \, \frac{\partial^3 \tau}{\partial y \partial l_x \partial l_y}+ \nonumber \\
2 \left(\frac{\partial^2 \tau}{\partial z \partial l_x}\right)
\left(\frac{\partial^2 \tau}{\partial z \partial l_y}\right) \, + 2
\frac{\partial \tau}{\partial z} \, \frac{\partial^3 \tau}{\partial
  z \partial l_x \partial l_y} = \frac{\partial^2 w}{\partial
  x \partial y}.
\label{eq:eikdsd2l}
\eea

Substituting the second derivative of traveltime with respect to
source location $D_{xy}=\frac{\partial^2 \tau}{\partial l_x \partial
  l_y}$ into equation~\ref{eq:eikdsd2l} provides us with a first order
linear equation in $D_{xy}$ given by: 
\bea 2 \left(\frac{\partial D_x}{\partial x}\right)
\left(\frac{\partial D_y}{\partial x}\right) \, + 2 \frac{\partial
  \tau}{\partial x} \, \frac{\partial D_{xy}}{\partial x} + 2
\left(\frac{\partial D_x}{\partial y}\right) \left(\frac{\partial
    D_y}{\partial y}\right) \, +
2 \frac{\partial \tau}{\partial y} \, \frac{\partial D_{xy}}{\partial y}+ \nonumber \\
2 \left(\frac{\partial D_x}{\partial z}\right) \left(\frac{\partial
    D_y}{\partial z}\right) \, + 2 \frac{\partial \tau}{\partial z} \,
\frac{\partial D_{xy}}{\partial z} = \frac{\partial^2 w}{\partial
  x \partial y}.
\label{eq:eikdsdd2}
\eea
or
\begin{equation}
\nabla D_x \cdot \nabla D_y \, + \,\nabla \tau \cdot \nabla D_{xy} \, = \, \frac{1}{2} \frac{\partial^2 w}{\partial x \partial y}.
\label{eq:eikdssM1}
\end{equation}

Similar equations for the rest of the matrix components are given by
\begin{equation}
\nabla D_x \cdot \nabla D_z \, + \,\nabla \tau \cdot \nabla D_{xz} \, = \, \frac{1}{2} \frac{\partial^2 w}{\partial x \partial z},
\label{eq:eikdssM2}
\end{equation}
and
\begin{equation}
\nabla D_y \cdot \nabla D_z \, + \,\nabla \tau \cdot \nabla D_{yz} \, = \, \frac{1}{2} \frac{\partial^2 w}{\partial y \partial z},
\label{eq:eikdssM3}
\end{equation}

%\begin{equation}\label{eqn:box}
%  t_D = \frac{\sqrt{3\,\left( s_C^2 (\triangle x)^2 - t_A^2 - t_B^2 - t_C^2\right) +
%      (t_A + t_B + t_C)^2} + (t_A + t_B + t_C)}{3}\;.
%\end{equation}
%\begin{equation}\label{eqn:bupdate}
%  (t_D - t_A)^2 + (t_D - t_B)^2 + (t_D - t_C)^2 = s_D^2 (\triangle x)^2\;.
%\end{equation}
%and so on.

\newpage

%\APPENDIX{A}
%\input{delaunay}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: t
%%% End: 
