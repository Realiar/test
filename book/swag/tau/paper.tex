\published{Geophysics, 78, no. 2, S81-S91, (2013)}

\lefthead{Ma and Alkhalifah}
\righthead{The pseudo depth domain}

\title{Wavefield extrapolation in pseudodepth domain}
\author{Xuxin Ma and Tariq Alkhalifah}

\address{Physical Sciences and Engineering Division \\
King Abdullah University of Science and Technology \\
Thuwal 23955-6900, Saudi Arabia}

\maketitle

\begin{abstract}
Wavefields are commonly computed in the Cartesian coordinate frame.
Its efficiency is inherently limited due to spatial oversampling in deep layers, where the velocity is high and wavelengths are long.
To alleviate this computational waste due to uneven wavelength sampling, we convert the vertical axis of the conventional domain from depth to vertical time
or pseudo depth.
This creates a nonorthognal Riemannian coordinate system.
Both isotropic and anisotropic wavefields can be extrapolated in the new coordinate frame with improved efficiency and good consistency with Cartesian domain extrapolation results. 
Prestack depth migrations are also evaluated based on the wavefield extrapolation in the pseudodepth domain.
\end{abstract}

%% ========================
\section{Introduction}
%% ========================

Migrations based on wavefield extrapolation, both in depth and in time, are used extensively for imaging complex subsurface structures.
Ray-based migrations such as Kirchhoff migration can not correctly image reflectors where multipathing occurs.
In all the wave-equation based migrations, the seismic image is constructed directly from the wavefields by applying a proper imaging condition to the extrapolated wavefields.
As a result, there is a constant demand of more accurate and more cost-effective means of wavefield extrapolation.

Wavefield extrapolation is commonly implemented by finite difference approximations using regularly spaced Cartesian meshes.
It is popular because there is no need to interpolate wavefields between the computation domain and physical space.
However, Cartesian coordinate frame is poor in several other aspects because it does not take into account the physics of the wavefield. For example, wavelength is varies in space due to velocity variation, and considering the regular spacing in conventional implementations, 
this could result in uneven spatial representation of wavefields. 
Specifically, we tend to undersample wavefields in layers with low velocities and oversample them in layers with high velocities. 
Another issue with the conventional Cartesian coordinate system arises with downward continuation in the presence of overturned events: the vertical 
extrapolation direction in a Cartesian mesh does not follow the direction of energy propagation.

Wavefield extrapolation in non-Cartesian coordinate frames has been address by several authors for different purposes. Among them, the Riemannian coordinate allows downward continuation with small dip angles due to the fact that the coordinates are more aligned with wave-propagation directions~\cite[]{sava:T45,shragge:T11}; tilted Cartesian coordinate allows imaging of steep dipping reflectors using downward continuation~\cite[]{shan:S185}.

Our goal is to develop and implement reverse-time migration using pseudodepth in the vertical direction, as opposed to the conventional depth. 
The pseudo depth is velocity dependent in a way that the wavelength remains constant in spite of the vertical velocity variation.
This allows the vertical axis to be discretized with less number of samples, and thus speed up imaging.
In this paper, we first develop the pseudodepth coordinate frame and the procedures needed to interpolate between pseudodepth and the Cartesian coordinates.
Next, we derive the proper extrapolation operators for isotropic and anisotropic media in the new coordinate frame.
Finally, we present examples of pseudodepth domain prestack depth migration and compare the cost and accuracy with Cartesian domain implementation.

%% ========================
\section{pseudodepth domain wave equation}
%% ========================

%% ========================
\subsection{Vertical time coordinate frame}
%% ========================

The concept of \textit{vertical time} has a long history in seismic exploration.
Vertical time $\tau$ is the vertical axis for time migration~\cite[]{yilmaz2001sda,claerbout-iei}.
It is defined as the \textit{two-way} traveltime measured by coinciding source and receiver on the surface
\begin{equation}
  \label{eq:tautw}
  \tau_{TW}(z) = 2 \int_0^z \frac{\mathrm{d} z^\prime}{v(z^\prime)} .
\end{equation}
For conventional time image applications, this equation is used in the context of laterally invariant media.
This is however, not adequate for imaging complex strudtures.
We argue that vertical time, although does not correspond to the actual two-way traveltime in complex velocites, still works fine as representation of the vertical axis.
Since wavefield extrapolation is usually not zero-offset, in this work we will use the \textit{one-way} vertical time, defined as
\begin{equation}
  \label{eq:tau}
  \tau(x,y,z) = \int_0^z \frac{\mathrm{d} z^\prime}{v_m(x,y,z^\prime)} ,
\end{equation}
Note that velocity $v_m$ does not have to be identical to the velocity in which we propagate wavefields. For example, one can choose a constant $v_m$, then the vertical time is simply a scaled version of depth, $\tau = z / v_m$.
In practice, we suggest using a smooth background velocity as $v_m$, because it helps regularize $\tau$ coordinate grids.
Here we retain the name ``vertical time'' for $\tau$, however, it should not be confused with the vertical time $\tau_{TW}$ used in time processing.
In other words, Equation~\ref{eq:tau} represent only a change of variable from $z$ to $\tau$.

Normally, wavefields are discretized on the Cartesian mesh with equally-spaced grids. For a monochromatic wave, wavelength changes with velocity and since the grid spacing is held constant, the number of samples per wavelength increases in layers with high velocities and decreases in layers with low velocities.
To avoid spatial aliasing, the maximum grid spacing is limited by $\Delta x \leq v_{\min} / (2 f_{\max})$, where $v_{\min}$ is the lowest velocity, often located in shallow layers.
As a result, the deep layers with high velocities are often oversampled. The increased sampling of the layers with high velocity raises the cost of wavefield extrapolation without enhancing image resolution. Introducing vertical time partially resolves this problem. This can be seen by taking difference of equation~\ref{eq:tau} between to time levels,
\begin{equation}
\Delta\tau \equiv \tau_{n+1} - \tau_{n} = \int_{z(\tau_n)}^{z(\tau_{n+1})} \frac{\mathrm{d} z^\prime}{v_m(x,y,z^\prime)} ,
\end{equation}
which corresponds to a fixed $\tau$ sampling, $\Delta\tau$.  This implies that the effective sampling in depth $z(\tau_{n+1}) - z(\tau_n)$ increases with velocity.
%% ======== Figure 1 ======== %%
\inputdir{vertical}
\sideplot{uCT}{width=.65\textwidth}{wavelength variation with depth $z$ (Left) and vertical time $\tau$ (Right) of a $5$Hz sine. The velocity profile is $v=1500+0.7z \; \mathrm{m/sec}$.}
%% ======== Figure 1 ======== %%

Figure~\ref{fig:uCT} shows a comparison of vertical sampling in depth $z$ and vertical time $\tau$. 
In the Cartesian domain on the left, the sampling of the wavefield is relatively coarse in shallow layers and becomes finer with depth. In the $\tau$ domain on the right, the wavefield is evenly sampled in spite of the velocity variation, for the same number of samples.

Equation~\ref{eq:tau} maps a depth point $(x,y,z)$ to vertical time point $(x,y,\tau)$.
The inverse mapping is also straighforward, from differentiation of inverse functions, it follows
\begin{equation}
  \label{eq:z}
  z(x,y,\tau) = \int_0^\tau v_m(x,y,\tau^\prime) \mathrm{d} \tau^\prime ,
\end{equation}
where the integration constant is zero because $\tau(z=0)=0$.

By changing the vertical axis from $z$ to $\tau$, the coordinate system is effectively changed from the Cartesian frame $\lbrace x_1,x_2,x_3\rbrace$ to a new coordinate frame $\lbrace\xi_1,\xi_2,\xi_3\rbrace$, where the two coordinate systems are related by
\begin{equation}
\label{eq:xi}
\xi_1 = x_1 \quad, \xi_2 = x_2 \quad, \xi_3 = \tau = \int_0^{x_3} \frac{\mathrm{d} x_3^\prime}{v_m(x_1,x_2,x_3^\prime)}
\end{equation}
As long as the funtions $x_i(\xi_1,\xi_2,\xi_3)$ and $\xi_i(x_1,x_2,x_3)$ are one-to-one and free from singularities, we can interpolate any space functions between the Cartesian and $\tau$ domains.
Figures~\ref{fig:linA} to~\ref{fig:linD} illustrate examples of such interpolations. The velocity field in the $\tau$ domain is obtained by interpolating the velocity in the Cartesian domain using Equation~\ref{eq:tau}. In Figures~\ref{fig:linA} and~\ref{fig:linB}, the mapping velocity $v_m$ is computed by stacking the true velocity $v$ horizontally, and thus it is laterally constant. As a result, the $\tau$ coordinate system is orthogonal. In Figures~\ref{fig:linC} and~\ref{fig:linD}, $\tau$ is computed from the true velocity, i.e. $v_m=v$, the resulting $\tau$ coordinate system is nonorthogonal due to the lateral variation of $v$.

%% ======== Figure 2 ======== %%
\inputdir{linear}
\multiplot{2}{linA,linB}{width=.45\textwidth}{A linear velocity model in (a) Cartesian domain and (b) orthogonal $\tau$ domain overlaid with $\tau$ domain mesh. The velocity is $v=1250+0.35x+0.3z \; \mathrm{m/sec}$.}
\multiplot{2}{linC,linD}{width=.45\textwidth}{The same velocity model as in Figure~\ref{fig:linA} in (a) Cartesian domain and (b) nonorthogonal $\tau$ domain overlaid with $\tau$ domain mesh.}
%% ======== Figure 2 ======== %%

The new coordinate system $(x,y,\tau)$ has mixed units of time in the vertical axis and distance in the horizontal axes.
Sometime it is more convenient to have distance units in all three axes of the space domain. To achieve this we can simply scale $\tau$ by some velocity funciton $\tilde{v}$
\begin{equation}
  \tilde{z}(\tau) = \int_0^\tau \tilde{v}(\tau^\prime) \mathrm{d} \tau^\prime = \int_0^z \frac{\tilde{v}}{v_m} \mathrm{d} z^\prime
\end{equation}
For example, if $\tilde{v}$ is set to constant, the pseudodepth is simply a linear scaling of $\tau$, $\tilde{z}(\tau) = \tilde{v} \tau$.
The importance of this step will be evident later as we look into anisotropic media.

%% ========================
\subsection{Isotropic extrapolations}
%% ========================

\cite{alkhalifah:105} obtained $\tau$-domain wave equation by applying a coordinate transformation to the conventional eikonal equation and then
develop the dynamic part by inverse Fourier transform in space and time to formulate a wave equation in $\tau$ domain.
Because of the high frequency assumption of eikonal equation, the resulting wave equation is not accurate in amplitudes.
Here, we derive the coordinate transformation to the differentiations in wave equation directly.

From Equations in~\ref{eq:xi}, we can obtain the Jacobian matrix associated with coordinate transformation from Cartesian domain $x_i$ to $\tau$-domain $\xi_i$
\begin{equation}
  \label{eq:jac}
  \mathbf{J} = \left[\frac{\partial \xi_i}{\partial x_j}\right] = \begin{bmatrix} 1 & 0 & 0 \\ 0 & 1 & 0 \\ \sigma_1 & \sigma_2 & 1 / v_m\end{bmatrix} ,
\end{equation}
where we have denoted horizontal variation of vertical time by $\sigma_i = \partial \tau / \partial x_i \; (i=1,2)$.
The nonzero off-diagonal elements in the Jacobian matrix $\mathbf{J}$ indicate that $\xi_i$ coordinates are nonorthogonal.
From the Jacobian matrix we can compute its metric tensor
\begin{equation}
\label{eq:gco}
[g^{ij}] = \mathbf{J} \mathbf{J}^T =
\begin{bmatrix}
  1 & & \sigma_1 \\
  & 1 & \sigma_2 \\
  \sigma_1 & \sigma_2 & \sigma_1^2 + \sigma_2^2 + \frac{1}{v_m^2}
\end{bmatrix} .
\end{equation}
and its determinant $g = 1 / \det(g^{ij}) = v_m^2$.
Using the Jacobian matrix defined in~\ref{eq:jac}, we obtain the following derivative transformations:
\begin{align}
\label{eq:chain}
\frac{\partial}{\partial x_1} & = \frac{\partial}{\partial \xi_1} + \sigma_1\frac{\partial}{\partial \xi_3} \nonumber \\
\frac{\partial}{\partial x_2} & = \frac{\partial}{\partial \xi_2} + \sigma_2\frac{\partial}{\partial \xi_3} \\
\frac{\partial}{\partial x_3} & = \frac{1}{v_m} \frac{\partial}{\partial \xi_3} \nonumber .
\end{align}
A brief overview of the relevant tensor calculus theory is enclosed in Appendix A.

%% two-way wave equation
The two-way wave equation may be written in the following first order system
\begin{equation}
\label{eq:wisoC}
\frac{\partial p}{\partial t} = v^2 \nabla\cdot\mathbf{q}
\quad \mathrm{and} \quad
\frac{\partial \mathbf{q}}{\partial t} = \nabla p ,
\end{equation}
where $p$ is stress and $-\mathbf{q}$ is particle momentum.
The gradient of a scalar $\phi$ in a general curvilinear coordinate frame $\xi_i$ is
\begin{equation}
\nabla \phi = \frac{\partial \phi}{\partial \xi_j} g^{ij} \mathbf{e}_i ,
\end{equation}
which upon substitution of $\tau$ domain metric tensor~\ref{eq:gco} gives the following form of the $\tau$ domain gradient operator
\begin{align}
\label{eq:grad}
\nabla \phi
& = \left(\frac{\partial \phi}{\partial \xi_1} + \sigma_1 \frac{\partial \phi}{\partial \xi_3} \right) \mathbf{e}_1 \nonumber \\
& + \left(\frac{\partial \phi}{\partial \xi_2} + \sigma_2 \frac{\partial \phi}{\partial \xi_3} \right)\mathbf{e}_2 \\
& + \left[\sigma_1 \frac{\partial \phi}{\partial \xi_1} + \sigma_2 \frac{\partial \phi}{\partial \xi_2} + \left(\sigma_1^2 + \sigma_2^2 + \frac{1}{v_m^2}\right)\frac{\partial \phi}{\partial \xi_3} \right]\mathbf{e}_3 \nonumber .
\end{align}
The divergence of vector $f = f_i\mathbf{e}_i$ in a general curvilinear coordinate frame $\xi_i$ is
\begin{equation}
\nabla \cdot \mathbf{f} =  \frac{1}{\sqrt{g}} \frac{\partial}{\partial \xi_i}\left(\sqrt{g} f_i\right) .
\end{equation}
Similarly we can find the $\tau$ domain divergence using equation~\ref{eq:gco} as follows
\begin{equation}
\label{eq:div}
\nabla \cdot \mathbf{f} = \frac{1}{v_m} \frac{\partial}{\partial \xi_i} \left(v_m f_i\right)
\end{equation}

A $\tau$ domain two-way wave equation is established by substituting the gradient and divergence operators in equations~\ref{eq:grad} and~\ref{eq:div} into equation~\ref{eq:wisoC},
\begin{align}
\label{eq:wisoT}
\frac{\partial p}{\partial t} & = \frac{v^2}{v_m} \sum_{i=1}^3 \frac{\partial}{\partial \xi_i} \left(v_m q_i\right) \nonumber \\
\frac{\partial q_i}{\partial t} & = \frac{\partial p}{\partial \xi_i} + \sigma_i \frac{\partial p}{\partial \xi_3} \quad (i=1,2) \\
\frac{\partial q_3}{\partial t} & = \sigma_1\frac{\partial p}{\partial \xi_1} + \sigma_2\frac{\partial p}{\partial \xi_2} + \left(\sigma_1^2+\sigma_2^2+\frac{1}{v_m^2}\right)\frac{\partial p}{\partial \xi_3} \nonumber .
\end{align}
This new wave equation is seemingly more complex then the normal two-way wave equation~\ref{eq:wisoC}. It, however, does not raise the computational cost significantly because the number of differentiations on the right-hand side of the system is $6$ for both Equations~\ref{eq:wisoT} and~\ref{eq:wisoC}. The only cost increase comes from the multiplication with the $\sigma_i$ terms, which is less costly than differentiations. As will be shown in the next section, the additional cost due to $\sigma_i$ terms is in practice offset by an efficiency gain due to reduced vertical sampling.

If the $\tau$ coordinate system is orthogonal, in other words, $v_m$ is laterally constant, and thus, $\sigma_i = 0$, then the Jacobian matrix becomes diagonal $\mathbf{J} = \mathrm{diag}(1,1,1/v_m)$ and the metric tensor $g^{ij} = \mathrm{diag}(1,1,1/v_m^2)$. The two-way wave equation~\ref{eq:wisoT} simplifies to
\begin{align}
\frac{\partial p}{\partial t} & = v^2 \sum_{i=1}^2\frac{\partial q_i}{\partial \xi_i} + \frac{v^2}{v_m}\frac{\partial}{\partial \xi_3}\left(v_m q_3\right) \nonumber \\
\frac{\partial q_i}{\partial t} & = \frac{\partial p}{\partial \xi_i} \quad (i=1,2) \\
\frac{\partial q_3}{\partial t} & = \frac{1}{v_m^2} \frac{\partial p}{\partial \xi_3} \nonumber . 
\end{align}
The simplicity of this equation allows us to reorganize it into a second-order form
\begin{equation}
\frac{\partial^2 p}{\partial t^2} = v^2 \left(\frac{\partial^2 p}{\partial x^2} + \frac{\partial^2 p}{\partial y^2}\right) + \frac{v^2}{v_m} \frac{\partial}{\partial \tau} \left(\frac{1}{v_m} \frac{\partial p}{\partial \tau}\right) ,
\end{equation}
which upon expansion becomes
\begin{equation}\label{eq:wisoT2}
\frac{\partial^2 p}{\partial t^2} = v^2 \left(\frac{\partial^2 p}{\partial x^2} + \frac{\partial^2 p}{\partial y^2}\right) + \frac{v^2}{v_m^2} \frac{\partial^2 p}{\partial \tau^2} - \frac{v^2}{v_m^3} \frac{\partial v_m}{\partial \tau} \frac{\partial p}{\partial \tau} .
\end{equation}
Since the first-order derivatives affect only the amplitude of the solution (Courant and Hilbert, 1989), the last term in Equation~\ref{eq:wisoT2} can be dropped while retaining a kinematically correct solution, the resulting wave equation is
\begin{equation}
\label{eq:ellip}
\frac{\partial^2 p}{\partial t^2} = v^2 \left(\frac{\partial^2 p}{\partial x^2} + \frac{\partial^2 p}{\partial y^2}\right) + \frac{v^2}{v_m^2} \frac{\partial^2 p}{\partial \tau^2} .
\end{equation}
When both $v$ and $v_m$ are constants, the wavefront described by Equation~\ref{eq:ellip} is an ellipse. This suggests that elliptical anisotropy can be viewed as a linear change of the variable $\tau = z / v_m$ to isotropic velocity.

%% ========================
\subsection{Anisotropic extrapolation}
%% ========================

%% choice of vm
Velocity variation with angle in anisotropic media allows more choices for the mapping velocity $v_m$ in Equation~\ref{eq:tau}.
It is natural to use, but not limited to, the vertical velocity, $v_v$, as $v_m$.

%% aniso parameterization
The kinematics of a quasi-P wave in an anisotropic acoustic medium can be characterized by three parameters: P-wave velocity in the direction of the axis of symmetry $v_v$, NMO velocity $v = v_v\sqrt{1+2\delta}$ and anellipticity $\eta = (\epsilon-\delta) / (1 + 2\delta)$~\cite[]{alkhalifah:1239}, here $\epsilon$ and $\delta$ are Thomsen parameters~\cite[]{thomsen:1954}.

%% vti wave equation
The quasi-P wave motion in transversely isotropic media with vertical axis of symmetry (VTI) is described by the following first-order system~\cite[]{duveneck:S65}
\begin{align}\label{eq:wvtiC}
\frac{\partial p_H}{\partial t} & = (1+2\eta)v^2 \left(\frac{\partial q_1}{\partial x_1} + \frac{\partial q_2}{\partial x_2}\right) + v v_v\frac{\partial q_3}{\partial x_3} \nonumber \\
\frac{\partial p_V}{\partial t} & = v v_v \left(\frac{\partial q_1}{\partial x_1} + \frac{\partial q_2}{\partial x_2}\right) + v_v^2 \frac{\partial q_3}{\partial x_3} \\
\frac{\partial q_i}{\partial t} & = \frac{\partial p_H}{\partial x_i} \quad (i=1,2) \nonumber \\
\frac{\partial q_3}{\partial t} & = \frac{\partial p_V}{\partial x_3} \nonumber,
\end{align}
where $p_H$ and $p_V$ are horizontal and vertical stresses, $-\mathbf{q}$ is the particle momentum.

In the $\tau$ domain, the wave equation is obtained by applying the chain rule~\ref{eq:chain} to~\ref{eq:wvtiC}, the resulting system of equations is
\begin{align}
\label{eq:wvtiT}
\frac{\partial p_H}{\partial t} & = (1+2\eta)v^2 \sum_{i=1}^2 \left(\frac{\partial q_i}{\partial \xi_i} + \sigma_i\frac{\partial q_i}{\partial \xi_3}\right) + \frac{v v_v}{v_m} \frac{\partial q_3}{\partial \xi_3} \nonumber \\
\frac{\partial p_V}{\partial t} & = v v_v \sum_{i=1}^2 \left(\frac{\partial q_i}{\partial \xi_i} + \sigma_i\frac{\partial q_i}{\partial \xi_3}\right) + \frac{v_v^2}{v_m} \frac{\partial q_3}{\partial \xi_3} \\
\frac{\partial q_i}{\partial t} & = \frac{\partial p_H}{\partial \xi_i} + \sigma_i\frac{\partial p_H}{\partial \xi_3} \quad (i=1,2) \nonumber \\
\frac{\partial q_3}{\partial t} & = \frac{1}{v_m} \frac{\partial p_V}{\partial \xi_3} \nonumber
\end{align}

Equation~\ref{eq:wvtiC} has the second-order form
\begin{align}\label{eq:wvtiC2}
\frac{\partial^2 p_H}{\partial t^2} & = (1+2\eta)v^2 \left(\frac{\partial^2}{\partial x_1^2} + \frac{\partial^2}{\partial x_2^2}\right) p_H + v v_v\frac{\partial^2 p_V}{\partial x_3^2} \nonumber \\
\frac{\partial^2 p_V}{\partial t^2} & = v v_v \left(\frac{\partial^2}{\partial x_1^2} + \frac{\partial^2}{\partial x_2^2}\right) p_H + v_v^2 \frac{\partial p_V}{\partial x_3^2} .
\end{align}
Similarly, the second order form of~\ref{eq:wvtiT} is
\begin{align}\label{eq:wvtiT2}
\frac{\partial^2 p_H}{\partial t^2} & = (1+2\eta)v^2 \left[ \left(\frac{\partial}{\partial \xi_1} + \sigma_1\frac{\partial}{\partial \xi_3}\right)^2 + \left(\frac{\partial}{\partial \xi_2} + \sigma_2\frac{\partial}{\partial \xi_3}\right)^2 \right] p_H + \frac{v v_v}{v_m} \frac{\partial}{\partial \xi_3} \left(\frac{1}{v_m} \frac{\partial p_V}{\partial \xi_3} \right) \nonumber \\
\frac{\partial^2 p_V}{\partial t^2} & = v v_v \left[ \left(\frac{\partial}{\partial \xi_1} + \sigma_1\frac{\partial}{\partial \xi_3}\right)^2 + \left(\frac{\partial}{\partial \xi_2} + \sigma_2\frac{\partial}{\partial \xi_3}\right)^2 \right] p_H + \frac{v_v^2}{v_m} \frac{\partial}{\partial \xi_3} \left(\frac{1}{v_m} \frac{\partial p_V}{\partial \xi_3} \right)
\end{align}

In addition to the cost reduction, the vertical time axis also allows time processing in VTI media to be independent of the vertical velocity $v_v$, which is usually unresolvable from surface seismic data. 

In transversely isotropic media with tilted axis of symmetry (TTI), the symmetry plane and symmetry axis are rotated by tilt angle $\theta$ and azimuth $\phi$. The two-way wave equation is obtained by substituting derivatives in Equation~\ref{eq:wvtiC} by the following relations 
\begin{align}\label{eq:ttirot}
\frac{\partial}{\partial x_1} & \leftarrow \cos\theta\cos\phi \frac{\partial}{\partial x_1} + \cos\theta\sin\phi \frac{\partial}{\partial x_2} - \sin\theta \frac{\partial}{\partial x_3} \nonumber \\
\frac{\partial}{\partial x_2} & \leftarrow -\sin\phi \frac{\partial}{\partial x_1} + \cos\phi \frac{\partial}{\partial x_2}  \\
\frac{\partial}{\partial x_3} & \leftarrow \sin\theta\cos\phi \frac{\partial}{\partial x_1} + \sin\theta\sin\phi \frac{\partial}{\partial x_2} + \cos\theta \frac{\partial}{\partial x_3} \nonumber .
\end{align}
In $\tau$ domain, the TTI extrapolation equation is obtained by replacing each of the spatial derivatives $\partial / \partial x_i \; (i=1,2,3)$ on the right-hand side of Equation~\ref{eq:ttirot} by the expressions given by chain rule in Equation~\ref{eq:chain}. The $\tau$ coordinate transformation does not affect stability of the extrapolation.

%% ========================
\subsection{Implementation aspects}
%% ========================

The Sampling of the $\tau$ axis should be small enough to avoid wavefield aliasing in the $\tau$ domain, for example
\begin{equation}
\Delta \tau \leq \frac{1}{10} \frac{v_{min}}{f_{max}} ,
\end{equation}
where $v_{min}$ is the minimum velocity in the model and $f_{max}$ is the maximum frequency of the wave. Accordingly, the number of samples representing the
$\tau$ axis should be chosen to cover the largest expected $\tau$ value,
\begin{equation}
n_\tau \Delta \tau \geq \max_{x,y} \int_0^z \frac{\mathrm{d} z^\prime}{v_m(x,y,z^\prime)} .
\end{equation}

The mapping velocity $v_m$ is often chosen as a slightly smoothed version of true velocity $v$. This is because the $\tau$ domain wave equation involves a differentiation 
of $v_m$, for example the first equation in~\ref{eq:wisoT}.

For second-order wave equations, the operators on the right-hand side can become significantly complicated in the $\tau$ domain, such as Equation~\ref{eq:wvtiT2}.
Thus,  it is more convenient to code up its first-order form~\ref{eq:wvtiT}. For consistency, we will extrapolate the wavefields using the first-order form for all the examples in this paper.
Thus, the time derivatives in these equations are approximated by central differences,
\begin{equation}
\frac{\partial p}{\partial t} \approx \frac{p^{n+1} - p^{n-1}}{2\Delta t},
\end{equation}
and the spatial derivatives are approximated using the Fourier pseudospectral approuch~\cite[]{gazdag:854,carcione:1304}, as follows
\begin{equation}
\frac{\partial p}{\partial x_1} \approx F_1^{-1}\lbrace\mathrm{i} k_1 F_1\lbrace p \rbrace\rbrace,
\end{equation}
where superscript $n$ indicate time steps, $F_i$ is the spatial Fourier transform in the $x_i$ direction.
The change of the vertical axis from $z$ to $\tau$ does not affect the stability condition.
For both isotropic and VTI extrapolations, the same time-step is used in both the Cartesian and $\tau$ domains.

%% ========================
\section{Examples}
%% ========================

%% ========================
\subsection{Impulse responses}
%% ========================

The $\tau$ domain wave equations in the previous section are derived for 3D models. For simplicity, the examples in this paper is for D models. 
Since the change in the vertical axis acts on a single vertical velocity profile at a time, the conclusions in this section can be extended to 3D case.
To test the accuracy of the $\tau$ domain wavefield extrapolation, we look at impulse responses of the $\tau$ domain migration operators and compare them 
with those obtained from the Cartesian domain extrapolations. A synthetic zero-offset section with three spikes are illustrated in Figure~\ref{fig:spike}.
Migration images obtained from this section are superpositions of the Green's functions due to a point source located at the center on the surface.

\inputdir{lens}
\sideplot{spike}{width=.9\textwidth}{Zero-offset section with three impulse events equally spaced in time. The source has peak frequency of $20$Hz. The lag between impulses is $0.5\mathrm{sec}$.}

Our first example is a lens velocity model, shown in Figure~\ref{fig:lengC}.
 The background velocity is $v = 2100 + .025z + .14x \; \mathrm{m/sec}$ and contains a negative anomaly of $-750 \; \mathrm{m/sec}$. We use the same velocity to obtain vertical time $\tau$, i.e. $v_m = v$ in Equation~\ref{eq:tau}. The $\tau$ mesh is overlaid on the velocity model, a prominent ``pull-down'' near the bottom of the model is due to the slow velocity lens. By the same analogy, a ``push-up'' will appear in the $\tau$ domain beneath a positive velocity anomaly, for example a salt body. By applying the change of variable in Equation~\ref{eq:tau}, the velocity is interpolated to the $\tau$ domain and plotted in Figure~\ref{fig:lengT}.
The $\tau$ axis is discretized by $401$ samples to speedup extrapolation and honor the aliasing condition.
The zero-offset section in Figure~\ref{fig:spike} is migrated using Equation~\ref{eq:wisoC} by extrapolating backward in time and applying zero-time imaging condition. The resulting image is shown in Figure~\ref{fig:leniC}. 
In the $\tau$ domain, the extrapolation is done by solving Equation~\ref{eq:wisoT}. Following the same imaging condition, the migrated image is shown in Figure~\ref{fig:leniT}.
This image is then interpolated back to the Cartesian domain using equation~\ref{eq:z}, and compared with Figure~\ref{fig:leniC}.
The error shown in Figure~\ref{fig:leniE}
is due to the linear interpolation between Cartesian and $\tau$ meshes, and it is relatively small.

\multiplot{6}{lengC,lengT,leniC,leniT,leniB,leniE}{width=.25\textwidth}{A lens velocity model in (a) Cartesian and (b) $\tau$ domains overlaid with $\tau$ mesh. Migration images are shown for (c) Cartesian and (d) $\tau$ domains. (e) is image (d) interpolated to the Cartesian domain. (f) is the relative error between (c) and (e). The model is discretized with $501$ samples in depth and $401$ samples in vertical time.}

%% marmousi
The next examples demonstrate extrapolation in complex models.
In Figure~\ref{fig:margC}, we show a section of the isotropic Marmousi velocity model. Since the vertical time derived from this velocity has very ragged curvatures that may pose stability difficulties for the $\tau$ domain extrapolation, in Equation~\ref{eq:tau} we use instead a smoothed version of the Marmousi velocity as $v_m$ to compute $\tau$. Interpolation of the Marmousi velocity on to the $\tau$ mesh is shown in Figure~\ref{fig:margT}. 
Impulse responses are obtained by solving Equations~\ref{eq:wisoC} (Figure~\ref{fig:mariC}) and~\ref{eq:wisoT} (Figure~\ref{fig:mariT}).
The error is plotted in Figure~\ref{fig:mariE} and it is relatively small.

\inputdir{marm}
\multiplot{6}{margC,margT,mariC,mariT,mariB,mariE}{width=.25\textwidth}{A portion of the Marmousi velocity in (a) Cartesian and (b) $\tau$ domains overlaid with the $\tau$ mesh. Migration images are shown for (c) Cartesian and (d) $\tau$ domains. (e) is image (d) interpolated to the Cartesian domain. (f) is the relative error between (c) and (e). The model is discretized with $751$ samples in depth and $501$ samples vertical time. The mapping velocity $v_m$ is smoothed from true velocity by using $8$-point triangle filter.}

%% hess

Extrapolation of anisotropic wavefields in the $\tau$ coordinates system is also feasible. The propagation of quasi-acoustic P waves is characterized by three parameters: vertical $P$-wave velocity $v_v$, NMO velocity $v$ and the anellipticity $\eta$.
For example, the anisotropic parameters of the SEG/Hess model are shown in Figures~\ref{fig:hesm1} to~\ref{fig:hesm3}.

\inputdir{hess}
\multiplot{3}{hesm1,hesm2,hesm3}{width=.25\textwidth}{A portion of the SEG/Hess anisotropic velocity model. (a) Vertical velocity (b) NMO velocity (c) $\eta$.}

Similar to isotropic complex models, to alleviate the distortion of the $\tau$ mesh due to the strong velocity variation of the  salt body, the $\tau$ mesh is constructed using a smooth background velocity $v_m$. 
The resulting $\tau$ coordinate system is overlaid on vertical velocities in the Cartesian and $\tau$ domains, shown in Figure~\ref{fig:hesgC} and~\ref{fig:hesgT}. 
The Cartesian domain impulse response is computed from Equation~\ref{eq:wvtiC}, Figure~\ref{fig:hesiC} shows the horizontal stress field $p_H$.
In the $\tau$ domain, the impulse response is obtained from equation~\ref{eq:wvtiT}, and the resulting $p_H$ field is shown in Figure~\ref{fig:hesiT}. 
As expected, the wavefield beneath the salt is ``pushed up'' due to positive velocity anomaly at salt dome. 
The error in the migration image obtained in $\tau$ domain is plotted in Figure~\ref{fig:hesiE}.

\multiplot{6}{hesgC,hesgT,hesiC,hesiT,hesiB,hesiE}{width=.25\textwidth}{The vertical velocity in (a) the Cartesian and (b) the $\tau$ domains overlaid with $\tau$ mesh. Migration images are shown for (c) Cartesian and (d) $\tau$ domains. (e) is image (d) interpolated to the Cartesian domain. (f) is the relative error between (c) and (e). The model is discretized with $601$ samples in depth and $501$ samples vertical time. The mapping velocity $v_m$ is smoothed from true velocity by using $8$-point triangle filter.}

Table~\ref{tbl:cost} summarizes the numerical cost of wavefield extrapolation in Cartesian and $\tau$ domains. For isotropic extrapolations, elapsed time is shorter in $\tau$ domain than in Cartesian domain, the percentage cut is close to the reduction of vertical sampling of the wavefield. For anisotropic extrapolations, the efficiency improvement is less significant, due to the increased number of derivatives on the right-hand side of equations~\ref{eq:wvtiT} as compared to Cartesian extrapolator~\ref{eq:wvtiC}.

% table
\tabl{cost}{Cost of wavefield extrapolation in Cartesian (c) and $\tau$ ($\tau$) domain, showing elapsed time $t$ in seconds and number of vertical samples $n$. Reduction of samples are computed by $(n_c - n_\tau) / n_c$. Speedup is estimated by $(t_c - t_\tau) / tc$.}{%
\begin{center}
\begin{tabular}{| c | c | c | c | c | c | c |}
\hline Model & $n_c$ & $n_\tau$ & reduction & $t_c$ & $t_\tau$ & speedup \\
\hline Lens (Figure~\ref{fig:lengC})     & 401 & 251 & 37.5\% & 18 & 12 & 33.3\% \\
\hline Marmousi (Figure~\ref{fig:margC}) & 751 & 501 & 33.3\% & 277& 193& 30.3\% \\
\hline SEG/Hess (Figure~\ref{fig:hesgC}) & 601 & 501 & 16.6\% & 102& 98 & 3.9\% \\
\hline
\end{tabular}
\end{center}
}

%% shear wave artefacts
%% need explanations

In addition to the reduced computational cost, $\tau$ anisotropic extrapolation also features attenuated shear wave artifacts. Figure~\ref{fig:arte} shows the impulse responses using a homogeneous anisotropic velocity model. The shear wave artifact is significant in the Cartesian domain, shown on the left.
In the $\tau$ domain, the artifact is attenuated with the coarser vertical sampling, as shown on the right. Coarser sampling enhance numerical dispersion of the shear wave, which tends to spread the energy across the domain, thus attenuates the shear wave artifact.

%. Since shear wave speed is smaller than acoustic wave, it requries a finer grid to avoid spatial aliasing. In fact the shear wave artefacts are aliased in both figures in Figure~\ref{fig:arte}. In $\tau$ domain, the vertical sampling is coarser than that in Cartesian domain, thus the aliasing is enhanced.

\inputdir{arte}
\multiplot{3}{arteC,arteZ,arteT}{width=0.29\textwidth}{\label{fig:arte}Anisotropic impulse response obtained in Cartesian (Left) and $\tau$ (Middle and Right) domains, showing attenuation of the shear wave artefact. In the Middle figure, the $\tau$ axis is sampled at $\Delta\tau = 2.5\, \mathrm{msec}$ with $401$ samples. In the Right figure, the $\tau$ axis is sampled at $\Delta\tau = 3.0 \, \mathrm{msec}$ with $301$ samples. The anisotropic model has vertical velocity $2000 \, \mathrm{m/sec}$, NMO velocity $1643 \, \mathrm{m/sec}$ and anellipticity $\eta=0.1$.}

%% ========================
\subsection{Prestack imaging}
%% ========================

%\inputdir{prestack}
\inputdir{.}

Using the $\tau$ domain two-way wave equation~\ref{eq:wisoT}, we apply reverse-time migration to Sigsbee2a synthetic dataset.
Figure~\ref{fig:sigsC} shows a standard RTM image obtained in the Cartesian domain. The vertical axis, depth $z$, is discretized into $1201$ samples.
Figure~\ref{fig:sigsT} shows an RTM image obtained in $\tau$ domain. The vertical axis has been replaced by vertical time $\tau$, with $751$ samples.
Thus, the model size in the $\tau$ domain has been reduced by $37.5\%$ compared to the Cartesian domain.
Measured by wall clock times, the $\tau$ domain RTM gained a total of $33\%$ speedup compared to Cartesian domain RTM, which  as expected, is close to the reduction of the model size. 

\multiplot{3}{sigsC,sigsT,sigsB}{width=.5\textwidth}{Prestack migration of the Sigsbee dataset. Images are obtained in (a) Cartesian and (b) $\tau$ domains. (c) is Figure (b) interpolated to Cartesian domain. The computational cost measured by wall clock time is $19$h$36$min for (a) and $13$h$03$min for (b). }

Similarly, anisotropic reverse-time migration can be implemented using Equation~\ref{eq:wvtiT}. 
Figure~\ref{fig:hessC} illustrates a migrated image of the SEG/Hess salt dataset, with $1500$ samples in vertical direction. In the $\tau$ domain, the models are discretized into $1200$ samples in vertical direction. 
Figure~\ref{fig:hessT} illustrates the $\tau$ domain migration image. Again, the $\tau$ domain RTM has seen $18\%$ speedup, due to a corresponding sampling reduction of $20\%$. Note as well that the first two reflections in the $\tau$
domain result is not aliased compared to its depth counterpart. This implies that if these reflections are crucial, then we will require even a denser depth sampling to avoid aliasing
up shallow. This will result in even a larger cost difference.

\multiplot{6}{hessC,hessT,hessB}{width=.5\textwidth}{Prestack migration of the SEG/Hess dataset. Images are obtained in (a) Cartesian and (b) $\tau$ domains. (c) is Figure (b) interpolated to Cartesian domain. The computational cost measured by wall clock time is $24$h$24$min for (a) and $20$h$02$min for (b).}


%% ========================
\section{Conclusion}
%% ========================

The oversampling of wavefields in the vertical direction is effectively resolved by converting the vertical axis from depth to vertical time. 
Depending on lateral variation of the chosen vertical time, the resulting coordinate system can be made orthogonal or nonorthogonal. 
We derived wave equations for time extrapolation of both isotropic and anisotropic wavefields in the vertical time coordinate frame. 
Extrapolation in the vertical time domain features reduced computation cost due to elimination of oversampling in vertical direction.
Using the $\tau$ domain extrapolators, over $30\%$ speedup are observed for both isotropic and anisotropic RTMs.

%% ========================
\section{Acknowledgments}
%% ========================
We thank KAUST for supporting this work. 
We are grateful to Mohammad Zuberi and Yunseok Choi for many helpful discussions.
The oustanding reviews by Alexey Stovas, Yu Zhang and an anonymous reviewer had great improved this manuscript.
We acknowledge Hess Corporation and SMAART consortium for releasing their synthetic salt datasets. 

%% ========================
\appendix
\section{Appendix A: Overview of tensor calculus}
%% ========================

% Derivation of the $tau$-domain wave equations are based on the theory of tensor calculus. 
Transofrmation between general coordinates is conveniently handled by tensor calculus.
We consider a genearl curvilinear, possibly nonorthogonal, coordinate system $\lbrace\xi_1,\xi_2,\xi_3\rbrace$ and Cartesian coordinates $\lbrace x_1,x_2,x_3\rbrace$. At each point $\mathbf{r}(\xi_1,\xi_2,\xi_3)$ in space, two sets of basis vectors exist: \textit{covariant vectors} $\mathbf{e}_i = \partial \mathbf{r} / \partial \xi_i$ and \textit{contravariant vectors} $\mathbf{e}^i = \nabla \xi_i$. 
Basis vectors $\mathbf{e}_i$ and $\mathbf{e}^i$ are, in general, not of unit length.
A \textit{metric tensor} is a second-order symmetric tensor from which the unit arc length, unit area and unit volume can be computed easily. Each element of the \textit{covariant metric tensor} $g_{ij}$ is the inner product of a pair of covariant vectors, $g_{ij} = \mathbf{e}_i \cdot \mathbf{e}_j$. The \textit{contravariant metric tensor} is defined similarly, $g^{ij} = \mathbf{e}^i \cdot \mathbf{e}^j$.
The two metric tensors form a pair of inverse matrices $g_{ij} = [g^{ij}]^{-1}$. If the curvilinear coordinate system $\xi_i$ is orthogonal, for example spherical coordinates, the two basis vectors coincide and metric tensors become diagonal matrices.

Transformations between coordinate systems are characterized by \textit{Jacobian matrix} $\mathbf{J}$, defined as $J_{ij} = \partial x^\prime_i / \partial x_j$ for the transformation from coordinate system $x_i$ to $x^\prime_i$. In the case that $x_i$ is Cartesian coordinates, we noticed that each row of $\mathbf{J}$ is one contravariant basis vector $\mathbf{e}^i$, thus the metric tensors can be computed from Jacobian matrix, $[g^{ij}] = \mathbf{J} \mathbf{J}^T$ and $[g_{ij}] = (\mathbf{J} \mathbf{J}^T)^{-1}$.

Once the basis vectors and metric tensors are known, differentiations in the curvilinear coordinates $\xi_i$ is straightforward. The gradient of scalar $\phi$ is~\cite[]{riley2006mm}
\begin{equation}
\nabla \phi = \frac{\partial \phi}{\partial \xi_j} g^{ij} \mathbf{e}_i ,
\end{equation}
and the divergence of $\mathbf{f} = f_i\mathbf{e}_i$ is
\begin{equation}
\nabla \cdot \mathbf{f} =  \frac{1}{\sqrt{g}} \frac{\partial}{\partial \xi_i}\left(\sqrt{g} f_i\right)
\end{equation}
where $g = \det(g_{ij})$. Combining these two expression give the Laplacian of scalar $\phi$
\begin{equation}
\nabla^2 \phi = \frac{1}{\sqrt{g}} \frac{\partial}{\partial \xi_i}\left(\sqrt{g} g^{ij} \frac{\partial \phi}{\partial \xi_j}\right) .
\end{equation}

%% ========================
\appendix
\section{Appendix B: $\tau$ domain traveltime}
%% ========================

A geometrical description of the $\tau$ domain isotropic wavefield can be achieved by looking at its eikonal. A dispersion relation associated with the $\tau$ domain wave equation~\ref{eq:wisoT} is obtained by taking Fourier transform of this equation in space and time, specifically, do the substitution $\partial t \rightarrow -i\omega$ and $\partial x_i \rightarrow i k_i$, the result is
\begin{equation}
\label{eq:wk}
\frac{\omega^2}{v^2} = \sum_{i=1}^2 \left(k_i + \sigma_i k_3\right)^2 + \frac{k_3^2}{v_m^2} .
\end{equation}
Note here $k_1$ and $k_2$ has units of $\mathrm{rad/m}$, while $k_3$ has the angular frequency unit of $\mathrm{rad/sec}$.

We then relate slowness vector $\mathbf{p}$ with wavenumber vector $\mathbf{k}$ by $\mathbf{k} = \omega \mathbf{p}$, thus the $\tau$ domain isotropic eikonal equation is
\begin{equation}
\label{eq:eik}
\frac{1}{v^2} = \sum_{i=1}^2 \left(p_i + \sigma_i p_3\right)^2 + \frac{p_3^2}{v_m^2}
\end{equation}
where $p_i = \partial T / \partial x_i$ is the component of slowness vector in the $x_i$ direction, $T$ is traveltime.
Similarly, while $p_1$ and $p_2$ has slowness units $\mathrm{sec/m}$, $p_3$ is dimensionless.
Alternatively, Equation~\ref{eq:eik} can be derived by applying chain rule~\ref{eq:chain} to the Cartesian domain eikonal $\sum_{i=1}^3 p_i^2 = 1/v^2$.

%% ========================
\appendix
\section{Appendix C: Stability analysis for $\tau$ domain extrapolation}
%% ========================

For homogeneous velocity and regularly spaced grids, the stability condition is often studied by Von Neumann analysis~\cite[]{trefethen:fd}. Consider $1$-D second-order wave equation,
\begin{equation}\label{eq:appc-wc}
u_{tt} = v^2 u_{zz} ,
\end{equation}
approximated by central difference in space and time
\begin{equation}\label{eq:appc-dc}
\frac{u_i^{n+1} - 2 u_i^n + u_i^{n-1}}{\Delta t^2} = v^2 \frac{u_{i+1}^n - 2 u_i^n + u_{i-1}^n}{\Delta z^2}
\end{equation}
where superscripts indicate time index and subscripts indicate space index.
Substitute ansatz $u_i^n = U^n\exp\left(\mathrm{i} \, k z_j\right)$ into Equation~\ref{eq:appc-dc} yields
\begin{equation}
U^2 + \left( 4 \frac{v^2\Delta t^2}{\Delta z^2} \sin^2\frac{k\Delta z}{2} - 2 \right) U + 1 = 0
\end{equation}
where amplification factor $U$ characterizes the growth of the numerical solution during iteration. Stability of the numerical solution requires $\lvert U\rvert \leq 1$ for all wavenumbers $k$. It can be shown that in order for the quadratic equation
\begin{equation}
U^2 + \beta U + 1 = 0 %% \quad (\beta \in \mathbb{R})
\end{equation}
to have bounded roots $\lvert U\rvert \leq 1$, it is necessary that $\lvert\beta\rvert \leq 2$. This is equivalent to
\begin{equation}
0 \leq \frac{v^2\Delta t^2}{\Delta z^2} \sin^2\frac{k\Delta z}{2} \leq 1  \quad \forall \; k
\end{equation}
thus yields the well-known CFL condition
\begin{equation}\label{eq:cfl-c}
\Delta t \leq \frac{\Delta x}{v} .
\end{equation}

In $\tau$ domain, the $1$-D problem can be extracted from the vertical component of Equation~\ref{eq:ellip}
\begin{equation}\label{eq:appc-wt}
u_{tt} = \frac{v^2}{v_m^2} u_{\tau\tau} .
\end{equation}
Following the same analysis for~\ref{eq:appc-dc}, we can obtain $\tau$ domain CFL condition
\begin{equation}\label{eq:cfl-t}
\Delta t \leq \frac{v_m}{v} \Delta \tau
\end{equation}

\bibliographystyle{seg}
\bibliography{tau}

